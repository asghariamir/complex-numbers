<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Numbers - Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f7faf9;
            color: #212121;
            line-height: 1.6;
        }

        /* Mathswell Navigation */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: .75rem 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .mathswell-nav .mw-link {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            color: #0f766e;
            padding: .3rem .7rem;
            border-radius: 999px;
            background: rgba(255,255,255,.95);
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            transition: all 0.3s ease;
        }

        .mathswell-nav .mw-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,.12);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #4b5563;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #e6fffb;
        }

        .tab-button.active {
            background: #0f766e;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards and Sections */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .intro-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .intro-header h1 {
            font-size: 2.5em;
            color: #0f766e;
            margin-bottom: 8px;
        }

        .intro-header p {
            font-size: 1.2em;
            color: #4b5563;
        }

        .concept-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .concept-card {
            background: linear-gradient(135deg, #e6fffb 0%, #f0fffe 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .concept-card h3 {
            color: #0f766e;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        /* Interactive Demo */
        .interactive-demo {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .demo-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .demo-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .demo-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .demo-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            background: #10b981;
            transform: translateY(-1px);
        }

        .demo-result {
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .nav-btn {
            padding: 14px 28px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #10b981;
            transform: translateX(4px);
        }

        /* Algebraic Explorer Styles */
        .expression-input-group {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .expression-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            margin-bottom: 16px;
        }

        .expression-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .preset-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .preset-pill {
            padding: 8px 16px;
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            color: #0f766e;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-pill:hover {
            background: #10b981;
            color: white;
        }

        .result-display {
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-display h3 {
            color: #0f766e;
            margin-bottom: 12px;
        }

        .math-output {
            font-size: 1.3em;
            text-align: center;
            margin: 16px 0;
        }

        .steps-container {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .step {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .step:last-child {
            border-bottom: none;
        }

        /* Complex Plane Canvas */
        .plane-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }

        .plane-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #10b981;
        }

        .control-button.secondary {
            background: #4b5563;
        }

        .control-button.secondary:hover {
            background: #6b7280;
        }

        /* Form Toggle */
        .form-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: white;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .form-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: #4b5563;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .form-btn.active {
            background: #0f766e;
            color: white;
        }

        /* Info boxes */
        .info-box {
            background: #f0fffe;
            border-left: 4px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #0f766e;
            margin-bottom: 8px;
        }

        /* Loading and AI status */
        .ai-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #e6fffb;
            border-radius: 999px;
            font-size: 13px;
            color: #0f766e;
            margin-left: 12px;
        }

        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #10b981;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            font-size: 14px;
            color: #92400e;
        }

        /* Equation solver specific */
        .equation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .equation-grid {
                grid-template-columns: 1fr;
            }
        }

        .roots-display {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .root-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .root-value {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #0f766e;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .intro-header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Mathswell Navigation -->
    <div class="mathswell-nav">
        <a href="/" class="mw-link">
            <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
            <span>MATHSWELL</span>
        </a>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="introduction">Introduction</button>
            <button class="tab-button" data-tab="algebraic">Algebraic Explorer</button>
            <button class="tab-button" data-tab="geometric">Geometric View</button>
            <button class="tab-button" data-tab="equations">Equation Solver</button>
        </div>

        <!-- Introduction Tab -->
        <div id="introduction" class="tab-content active">
            <div class="intro-header">
                <h1>Complex Numbers</h1>
                <p>Impossible numbers that create endless possibilities</p>
            </div>

            <!-- Concept Cards -->
            <div class="concept-cards">
                <div class="concept-card">
                    <h3>What is <span class="math">i</span>?</h3>
                    <p>The imaginary unit <span class="math">i</span> is defined as the square root of -1.</p>
                    <div class="math-output" id="i-definition"></div>
                    <p>This "impossible" number opens up a whole new world of mathematics!</p>
                </div>

                <div class="concept-card">
                    <h3>Complex Numbers: a + bi</h3>
                    <p>Every complex number has a real part (a) and an imaginary part (b).</p>
                    <div class="math-output" id="complex-form"></div>
                    <p>They follow all the rules of arithmetic we know and love.</p>
                </div>

                <div class="concept-card">
                    <h3>Solving the Impossible</h3>
                    <p>With complex numbers, every polynomial equation has a solution!</p>
                    <div class="math-output" id="solving-example"></div>
                    <p>No more "no solution" - everything becomes solvable.</p>
                </div>
            </div>

            <!-- Interactive Demo -->
            <div class="interactive-demo">
                <h2>See the Magic: Factoring x² + 1</h2>
                <p>Once impossible, now simple with complex numbers!</p>
                
                <div class="demo-controls">
                    <input type="text" class="demo-input" id="poly-input" value="x^2 + 1" placeholder="Enter polynomial (e.g., x^2 + 1)">
                    <button class="demo-button" onclick="factorPolynomial()">Factor</button>
                </div>
                
                <div class="demo-result" id="factor-result">
                    <div id="factor-display"></div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="card">
                <h2>Two Perspectives on Complex Numbers</h2>
                
                <div class="info-box">
                    <h4>1. Algebraic Perspective</h4>
                    <p>Complex numbers extend our number system. Just as negative numbers let us solve x + 5 = 3, 
                    complex numbers let us solve x² + 1 = 0. They complete our arithmetic, making every polynomial solvable.</p>
                </div>
                
                <div class="info-box">
                    <h4>2. Geometric Perspective</h4>
                    <p>Complex numbers are points on a 2D plane. Addition is translation, multiplication is rotation and scaling. 
                    This geometric view reveals beautiful patterns and deep connections to trigonometry.</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" onclick="switchTab('algebraic')">
                    Try Algebraic Explorer →
                </button>
                <button class="nav-btn" onclick="switchTab('geometric')">
                    Explore Geometry →
                </button>
                <button class="nav-btn" onclick="switchTab('equations')">
                    Solve Equations →
                </button>
            </div>
        </div>

        <!-- Algebraic Explorer Tab -->
        <div id="algebraic" class="tab-content">
            <div class="card">
                <h2>Algebraic Explorer</h2>
                <p>Transform any complex expression into standard form a + bi</p>
                
                <div class="disclaimer">
                    ⚡ AI-powered simplification - The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic
                </div>
            </div>

            <div class="expression-input-group">
                <h3>Enter Complex Expression</h3>
                <input type="text" class="expression-input" id="complex-expression" 
                       placeholder="e.g., (2+3i)*(1-i) or (1+i)^3" 
                       value="(2+3i)*(1-i)">
                
                <div class="preset-pills">
                    <button class="preset-pill" onclick="setExpression('(3+2i) + (1-4i)')">Addition</button>
                    <button class="preset-pill" onclick="setExpression('(2+3i) * (1-i)')">Multiplication</button>
                    <button class="preset-pill" onclick="setExpression('(3+2i) / (1-i)')">Division</button>
                    <button class="preset-pill" onclick="setExpression('(1+i)^4')">Powers</button>
                    <button class="preset-pill" onclick="setExpression('i^17')">Powers of i</button>
                    <button class="preset-pill" onclick="setExpression('((2+i)*(3-2i))/(1+i)')">Complex</button>
                </div>
                
                <button class="demo-button" onclick="simplifyExpression()">
                    Simplify <span class="ai-status" id="ai-status" style="display:none;"><span class="loading-spinner"></span> AI working...</span>
                </button>
            </div>

            <div class="result-display" id="algebraic-result" style="display:none;">
                <h3>Result</h3>
                <div class="math-output" id="simplified-result"></div>
                
                <div class="steps-container" id="steps-container" style="display:none;">
                    <h4>Step-by-Step Solution</h4>
                    <div id="solution-steps"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <canvas id="result-plane" width="300" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Geometric View Tab -->
        <div id="geometric" class="tab-content">
            <div class="card">
                <h2>Geometric View</h2>
                <p>Visualize complex numbers as points and see operations as transformations</p>
            </div>

            <div class="plane-container">
                <h3>Complex Plane</h3>
                
                <div class="form-toggle">
                    <button class="form-btn active" onclick="setForm('rectangular')">Rectangular (a + bi)</button>
                    <button class="form-btn" onclick="setForm('polar')">Polar (r∠θ)</button>
                    <button class="form-btn" onclick="setForm('exponential')">Exponential (re^(iθ))</button>
                </div>
                
                <canvas id="complex-plane" width="600" height="600"></canvas>
                
                <div class="plane-controls">
                    <button class="control-button" onclick="addComplexNumber()">Add Number</button>
                    <button class="control-button" onclick="multiplyNumbers()">Multiply Selected</button>
                    <button class="control-button secondary" onclick="clearPlane()">Clear</button>
                    <button class="control-button secondary" onclick="showUnitCircle()">Unit Circle</button>
                </div>
                
                <div id="geometric-info" class="info-box" style="margin-top: 20px;">
                    <h4>Current Selection</h4>
                    <div id="selection-info">Click on the plane to add complex numbers</div>
                </div>
            </div>

            <div class="card">
                <h3>Multiplication as Rotation</h3>
                <p>Watch how multiplying complex numbers combines their angles and scales their magnitudes!</p>
                
                <div class="demo-controls">
                    <input type="text" class="demo-input" id="mult-z1" value="1+i" placeholder="First number">
                    <input type="text" class="demo-input" id="mult-z2" value="i" placeholder="Second number">
                    <button class="demo-button" onclick="animateMultiplication()">Animate</button>
                </div>
                
                <div id="mult-visualization" class="result-display" style="margin-top: 20px;">
                    <!-- Animation will go here -->
                </div>
            </div>
        </div>

        <!-- Equation Solver Tab -->
        <div id="equations" class="tab-content">
            <div class="card">
                <h2>Complex Equation Solver</h2>
                <p>Solve equations with complex solutions and explore roots of unity</p>
                
                <div class="disclaimer">
                    ⚡ AI-powered solver - The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic
                </div>
            </div>

            <div class="expression-input-group">
                <h3>Enter Equation</h3>
                <input type="text" class="expression-input" id="equation-input" 
                       placeholder="e.g., z^3 = 1 or z^2 + 2z + 5 = 0" 
                       value="z^4 = 1">
                
                <div class="preset-pills">
                    <button class="preset-pill" onclick="setEquation('z^3 = 1')">Cube Roots of Unity</button>
                    <button class="preset-pill" onclick="setEquation('z^6 = 1')">6th Roots of Unity</button>
                    <button class="preset-pill" onclick="setEquation('z^2 + 2z + 5 = 0')">Quadratic</button>
                    <button class="preset-pill" onclick="setEquation('z^4 = 16')">Fourth Roots</button>
                    <button class="preset-pill" onclick="setEquation('z^3 = -8')">Cube Roots of -8</button>
                </div>
                
                <button class="demo-button" onclick="solveEquation()">
                    Solve <span class="ai-status" id="solver-status" style="display:none;"><span class="loading-spinner"></span> AI solving...</span>
                </button>
            </div>

            <div class="equation-grid" id="equation-results" style="display:none;">
                <div class="roots-display">
                    <h3>Solutions</h3>
                    <div id="roots-list"></div>
                </div>
                
                <div class="plane-container">
                    <h3>Roots on Complex Plane</h3>
                    <canvas id="roots-plane" width="400" height="400"></canvas>
                </div>
            </div>
            
            <div class="info-box" id="equation-explanation" style="display:none; margin-top: 20px;">
                <h4>Understanding the Pattern</h4>
                <div id="pattern-explanation"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'introduction';
        let currentForm = 'rectangular';
        let complexNumbers = [];
        let selectedNumbers = [];
        
        // Initialize KaTeX renders
        document.addEventListener('DOMContentLoaded', function() {
            // Render initial math
            katex.render("i = \\sqrt{-1}", document.getElementById('i-definition'), {
                displayMode: true,
                throwOnError: false
            });
            
            katex.render("z = a + bi", document.getElementById('complex-form'), {
                displayMode: true,
                throwOnError: false
            });
            
            katex.render("x^2 + 1 = (x + i)(x - i)", document.getElementById('solving-example'), {
                displayMode: true,
                throwOnError: false
            });
            
            // Initialize canvases
            initializeGeometricPlane();
        });

        // Tab switching
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // Initialize specific tab features if needed
            if (tabName === 'geometric') {
                drawComplexPlane();
            }
        }

        // Add tab button listeners
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // AI API call function
        async function callAI(prompt, maxRetries = 2) {
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: prompt }] }] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Empty response from AI');
                    }
                    
                    return text;
                    
                } catch (error) {
                    if (attempt === maxRetries) {
                        throw error;
                    }
                }
            }
        }

        // Introduction tab functions
        function factorPolynomial() {
            const input = document.getElementById('poly-input').value;
            const display = document.getElementById('factor-display');
            
            // Simple factoring for demo
            if (input.toLowerCase().includes('x^2') && input.includes('1')) {
                katex.render("x^2 + 1 = (x + i)(x - i)", display, {
                    displayMode: true,
                    throwOnError: false
                });
            } else if (input.toLowerCase().includes('x^2') && input.includes('4')) {
                katex.render("x^2 + 4 = (x + 2i)(x - 2i)", display, {
                    displayMode: true,
                    throwOnError: false
                });
            } else {
                display.innerHTML = "Try x² + 1 or x² + 4 to see the factorization!";
            }
        }

        // Algebraic Explorer functions
        function setExpression(expr) {
            document.getElementById('complex-expression').value = expr;
        }

        async function simplifyExpression() {
            const expression = document.getElementById('complex-expression').value;
            const statusEl = document.getElementById('ai-status');
            const resultEl = document.getElementById('algebraic-result');
            const simplifiedEl = document.getElementById('simplified-result');
            const stepsEl = document.getElementById('solution-steps');
            const stepsContainer = document.getElementById('steps-container');
            
            if (!expression) {
                alert('Please enter an expression');
                return;
            }
            
            statusEl.style.display = 'inline-flex';
            
            const prompt = `Simplify the complex number expression: ${expression}
            
            Provide the result in the form a + bi (or a - bi if b is negative).
            Also provide step-by-step solution.
            
            Format your response as JSON:
            {
                "result": "the simplified form a + bi",
                "real": numerical_value,
                "imaginary": numerical_value,
                "steps": ["step 1", "step 2", ...]
            }
            
            Be precise with the calculations. If the result is a real number, write it as "a + 0i".
            If it's purely imaginary, write it as "0 + bi".`;
            
            try {
                const response = await callAI(prompt);
                const data = JSON.parse(response);
                
                // Display result
                katex.render(data.result, simplifiedEl, {
                    displayMode: true,
                    throwOnError: false
                });
                
                // Display steps
                if (data.steps && data.steps.length > 0) {
                    stepsEl.innerHTML = data.steps.map((step, i) => 
                        `<div class="step">${i + 1}. ${step}</div>`
                    ).join('');
                    stepsContainer.style.display = 'block';
                }
                
                // Draw on mini complex plane
                const canvas = document.getElementById('result-plane');
                drawMiniPlane(canvas, data.real, data.imaginary);
                
                resultEl.style.display = 'block';
                
            } catch (error) {
                console.error('AI simplification failed:', error);
                // Fallback to basic calculation
                simplifiedEl.innerHTML = `Unable to simplify with AI. The expression is: ${expression}`;
                resultEl.style.display = 'block';
            } finally {
                statusEl.style.display = 'none';
            }
        }

        function drawMiniPlane(canvas, real, imag) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 30; // pixels per unit
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            // Grid lines
            for (let i = -4; i <= 4; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw the complex number
            const x = centerX + real * scale;
            const y = centerY - imag * scale;
            
            // Draw line from origin
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw point
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Label
            ctx.fillStyle = '#212121';
            ctx.font = '12px sans-serif';
            ctx.fillText(`${real.toFixed(2)} + ${imag.toFixed(2)}i`, x + 10, y - 10);
        }

        // Geometric View functions
        function initializeGeometricPlane() {
            if (currentTab === 'geometric') {
                drawComplexPlane();
            }
        }

        function drawComplexPlane() {
            const canvas = document.getElementById('complex-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 50; // pixels per unit
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -5; i <= 5; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#4b5563';
            ctx.font = '14px sans-serif';
            ctx.fillText('Real', width - 40, centerY - 10);
            ctx.fillText('Imaginary', centerX + 10, 20);
            
            // Draw existing complex numbers
            complexNumbers.forEach(z => {
                drawComplexNumber(ctx, z, centerX, centerY, scale);
            });
        }

        function drawComplexNumber(ctx, z, centerX, centerY, scale) {
            const x = centerX + z.real * scale;
            const y = centerY - z.imag * scale;
            
            // Draw line from origin
            ctx.strokeStyle = z.selected ? '#f59e0b' : '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw point
            ctx.fillStyle = z.selected ? '#f59e0b' : '#0f766e';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Label
            ctx.fillStyle = '#212121';
            ctx.font = '12px sans-serif';
            const label = `${z.real.toFixed(1)} + ${z.imag.toFixed(1)}i`;
            ctx.fillText(label, x + 10, y - 10);
        }

        function setForm(form) {
            currentForm = form;
            document.querySelectorAll('.form-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update display for existing numbers
            updateGeometricInfo();
        }

        function addComplexNumber() {
            const real = Math.random() * 4 - 2;
            const imag = Math.random() * 4 - 2;
            complexNumbers.push({ real, imag, selected: false });
            drawComplexPlane();
        }

        function multiplyNumbers() {
            if (selectedNumbers.length !== 2) {
                alert('Please select exactly 2 numbers to multiply');
                return;
            }
            
            const z1 = selectedNumbers[0];
            const z2 = selectedNumbers[1];
            
            // Complex multiplication: (a+bi)(c+di) = (ac-bd) + (ad+bc)i
            const real = z1.real * z2.real - z1.imag * z2.imag;
            const imag = z1.real * z2.imag + z1.imag * z2.real;
            
            complexNumbers.push({ real, imag, selected: false });
            selectedNumbers = [];
            complexNumbers.forEach(z => z.selected = false);
            drawComplexPlane();
            
            // Show result
            const info = document.getElementById('selection-info');
            info.innerHTML = `Result: ${real.toFixed(2)} + ${imag.toFixed(2)}i`;
        }

        function clearPlane() {
            complexNumbers = [];
            selectedNumbers = [];
            drawComplexPlane();
        }

        function showUnitCircle() {
            const n = 8; // Show 8th roots of unity
            complexNumbers = [];
            for (let k = 0; k < n; k++) {
                const angle = 2 * Math.PI * k / n;
                complexNumbers.push({
                    real: Math.cos(angle),
                    imag: Math.sin(angle),
                    selected: false
                });
            }
            drawComplexPlane();
        }

        function updateGeometricInfo() {
            const info = document.getElementById('selection-info');
            if (selectedNumbers.length > 0) {
                const z = selectedNumbers[0];
                const r = Math.sqrt(z.real * z.real + z.imag * z.imag);
                const theta = Math.atan2(z.imag, z.real);
                
                let display = '';
                switch(currentForm) {
                    case 'rectangular':
                        display = `${z.real.toFixed(2)} + ${z.imag.toFixed(2)}i`;
                        break;
                    case 'polar':
                        display = `${r.toFixed(2)} ∠ ${(theta * 180 / Math.PI).toFixed(1)}°`;
                        break;
                    case 'exponential':
                        display = `${r.toFixed(2)} e^(${theta.toFixed(2)}i)`;
                        break;
                }
                info.innerHTML = display;
            }
        }

        function animateMultiplication() {
            const z1Input = document.getElementById('mult-z1').value;
            const z2Input = document.getElementById('mult-z2').value;
            const vizDiv = document.getElementById('mult-visualization');
            
            // Parse inputs (simplified)
            // This would need proper parsing in production
            vizDiv.innerHTML = `
                <p>Multiplying ${z1Input} by ${z2Input}</p>
                <p>Result will appear here with animation...</p>
            `;
        }

        // Complex plane interaction
        document.getElementById('complex-plane')?.addEventListener('click', function(e) {
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = this.width / 2;
            const centerY = this.height / 2;
            const scale = 50;
            
            const real = (x - centerX) / scale;
            const imag = -(y - centerY) / scale;
            
            // Check if clicking near existing number
            let clickedNumber = null;
            complexNumbers.forEach(z => {
                const zx = centerX + z.real * scale;
                const zy = centerY - z.imag * scale;
                const dist = Math.sqrt((x - zx) ** 2 + (y - zy) ** 2);
                if (dist < 10) {
                    clickedNumber = z;
                }
            });
            
            if (clickedNumber) {
                clickedNumber.selected = !clickedNumber.selected;
                if (clickedNumber.selected) {
                    selectedNumbers.push(clickedNumber);
                } else {
                    selectedNumbers = selectedNumbers.filter(z => z !== clickedNumber);
                }
            } else {
                complexNumbers.push({ real, imag, selected: false });
            }
            
            drawComplexPlane();
            updateGeometricInfo();
        });

        // Equation Solver functions
        function setEquation(eq) {
            document.getElementById('equation-input').value = eq;
        }

        async function solveEquation() {
            const equation = document.getElementById('equation-input').value;
            const statusEl = document.getElementById('solver-status');
            const resultsEl = document.getElementById('equation-results');
            const rootsList = document.getElementById('roots-list');
            const explanationEl = document.getElementById('equation-explanation');
            const patternEl = document.getElementById('pattern-explanation');
            
            if (!equation) {
                alert('Please enter an equation');
                return;
            }
            
            statusEl.style.display = 'inline-flex';
            
            const prompt = `Solve the complex equation: ${equation}
            
            Find all complex solutions. For roots of unity, give exact values using radicals and fractions where possible.
            
            Format your response as JSON:
            {
                "roots": [
                    {"real": number, "imaginary": number, "exact": "exact form like 1/2 + √3/2 i"},
                    ...
                ],
                "pattern": "Explanation of the pattern or structure of these roots",
                "method": "Brief explanation of solving method"
            }
            
            Be precise. List ALL roots. For roots of unity, they should be evenly spaced around the unit circle.`;
            
            try {
                const response = await callAI(prompt);
                const data = JSON.parse(response);
                
                // Display roots
                rootsList.innerHTML = data.roots.map((root, i) => `
                    <div class="root-item">
                        <span>Root ${i + 1}:</span>
                        <span class="root-value">${root.exact || `${root.real.toFixed(3)} + ${root.imaginary.toFixed(3)}i`}</span>
                    </div>
                `).join('');
                
                // Draw roots on plane
                const canvas = document.getElementById('roots-plane');
                drawRootsPlane(canvas, data.roots);
                
                // Show pattern explanation
                patternEl.innerHTML = `<p>${data.pattern}</p><p><strong>Method:</strong> ${data.method}</p>`;
                
                resultsEl.style.display = 'grid';
                explanationEl.style.display = 'block';
                
            } catch (error) {
                console.error('AI solver failed:', error);
                // Fallback
                rootsList.innerHTML = '<div class="root-item">Unable to solve with AI. Please try a simpler equation.</div>';
                resultsEl.style.display = 'grid';
            } finally {
                statusEl.style.display = 'none';
            }
        }

        function drawRootsPlane(canvas, roots) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 80; // pixels per unit
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -2; i <= 2; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw unit circle
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, scale, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw roots
            roots.forEach((root, i) => {
                const x = centerX + root.real * scale;
                const y = centerY - root.imaginary * scale;
                
                // Draw line from origin
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw point
                ctx.fillStyle = '#0f766e';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#212121';
                ctx.font = '11px sans-serif';
                ctx.fillText(`z${i+1}`, x + 8, y - 8);
            });
        }

        // Initialize the first polynomial factor on load
        setTimeout(() => factorPolynomial(), 500);
    </script>
</body>
</html>
