<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Numbers - Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f7faf9;
            color: #212121;
            line-height: 1.6;
        }

        /* Mathswell Navigation */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: .75rem 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .mathswell-nav .mw-link {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            color: #0f766e;
            padding: .3rem .7rem;
            border-radius: 999px;
            background: rgba(255,255,255,.95);
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            transition: all 0.3s ease;
        }

        .mathswell-nav .mw-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,.12);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #4b5563;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #e6fffb;
        }

        .tab-button.active {
            background: #0f766e;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards and Sections */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .intro-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .intro-header h1 {
            font-size: 2.5em;
            color: #0f766e;
            margin-bottom: 8px;
        }

        .intro-header p {
            font-size: 1.2em;
            color: #4b5563;
        }

        .concept-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .concept-card {
            background: linear-gradient(135deg, #e6fffb 0%, #f0fffe 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .concept-card h3 {
            color: #0f766e;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        /* Interactive Demo */
        .interactive-demo {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .demo-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .slider-group label {
            font-weight: 600;
            color: #4b5563;
            min-width: 30px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0f766e;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0f766e;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #0f766e;
        }

        .demo-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            background: #10b981;
            transform: translateY(-1px);
        }

        .demo-result {
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }

        .math-display {
            margin: 8px 0;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .nav-btn {
            padding: 14px 28px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #10b981;
            transform: translateX(4px);
        }

        /* Example boxes */
        .example-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .example-step {
            margin: 8px 0;
            padding-left: 20px;
        }

        /* User input styles */
        .user-answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
        }

        .user-answer-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .preset-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .preset-pill {
            padding: 8px 16px;
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            color: #0f766e;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-pill:hover {
            background: #10b981;
            color: white;
        }

        /* Complex Plane Canvas */
        .plane-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }

        .plane-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #10b981;
        }

        .control-button.secondary {
            background: #4b5563;
        }

        .control-button.secondary:hover {
            background: #6b7280;
        }

        /* Info boxes */
        .info-box {
            background: #f0fffe;
            border-left: 4px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #0f766e;
            margin-bottom: 8px;
        }

        .summary-box {
            background: linear-gradient(135deg, #e6fffb 0%, #f0fffe 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-top: 32px;
        }

        .summary-box h3 {
            color: #0f766e;
            margin-bottom: 12px;
        }

        /* Formula display */
        .formula-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        /* Problem selector */
        .problem-selector {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Feedback boxes */
        .feedback-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .feedback-box.peer {
            background: #e6fffb;
            border: 2px solid #10b981;
            color: #0f766e;
        }

        .feedback-box.correct {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }

        /* Unit circle for powers of i */
        .unit-circle-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .unit-circle-visual {
            flex: 1;
            min-width: 300px;
        }

        .powers-list {
            flex: 1;
            min-width: 200px;
        }

        /* Two-column button layout */
        .button-row {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        /* Geometric interaction */
        .geometric-controls {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .number-input-group {
            flex: 1;
            min-width: 200px;
        }

        .number-input-group label {
            display: block;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .number-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
        }

        .peer-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .peer-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agree-btn {
            background: #10b981;
            color: white;
        }

        .agree-btn:hover {
            background: #059669;
        }

        .challenge-btn {
            background: #f59e0b;
            color: white;
        }

        .challenge-btn:hover {
            background: #d97706;
        }

        .show-solution-btn {
            background: #4b5563;
            color: white;
        }

        .show-solution-btn:hover {
            background: #6b7280;
        }

        .solution-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .power-display {
            font-size: 1.5em;
            text-align: center;
            margin: 20px 0;
            color: #0f766e;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .intro-header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
            }

            .button-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Mathswell Navigation -->
    <div class="mathswell-nav">
        <a href="/" class="mw-link">
            <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
            <span>MATHSWELL</span>
        </a>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="introduction">Introduction</button>
            <button class="tab-button" data-tab="algebraic">Algebraic Explorer</button>
            <button class="tab-button" data-tab="geometric">Geometric View</button>
            <button class="tab-button" data-tab="exploration">Exploration</button>
        </div>

        <!-- Introduction Tab -->
        <div id="introduction" class="tab-content active">
            <div class="intro-header">
                <h1>Complex Numbers</h1>
                <p>Impossible numbers that create endless possibilities</p>
            </div>

            <!-- Concept Cards -->
            <div class="concept-cards">
                <div class="concept-card">
                    <h3>The Imaginary Unit <em>i</em></h3>
                    <p>We define <strong><em>i</em></strong> as something whose square is -1:</p>
                    <div class="math-display" id="i-definition"></div>
                    <p>This "impossible" idea unlocks a whole new mathematical universe!</p>
                </div>

                <div class="concept-card">
                    <h3>Complex Numbers: a + bi</h3>
                    <p>Every complex number combines real and imaginary parts:</p>
                    <div class="math-display" id="complex-form"></div>
                    <p>They follow all arithmetic rules, always simplifying to this form.</p>
                </div>
            </div>

            <!-- Interactive Demo 1: Factoring x² + c -->
            <div class="interactive-demo">
                <h2>Factoring <span id="factor-header"></span></h2>
                <p>See how complex numbers let us factor any quadratic, even when c is positive!</p>
                
                <div class="demo-controls">
                    <div class="slider-group">
                        <label>c =</label>
                        <input type="range" class="slider" id="c-slider" min="-10" max="10" value="1" step="1">
                        <span class="slider-value" id="c-value">1</span>
                    </div>
                </div>
                
                <div class="demo-result">
                    <div class="math-display" id="factor-display"></div>
                    <div class="math-display" id="factor-roots"></div>
                </div>
            </div>

            <!-- Interactive Demo 2: Solving Quadratics -->
            <div class="interactive-demo">
                <h2>Solving Any Quadratic</h2>
                <p>When the discriminant is negative, we can now find solutions using complex numbers!</p>
                
                <div style="margin-top: 20px;">
                    <p><strong>Try your own quadratic:</strong></p>
                    <div class="demo-controls">
                        <div class="slider-group">
                            <label>b =</label>
                            <input type="range" class="slider" id="b-slider" min="-10" max="10" value="-10" step="1">
                            <span class="slider-value" id="b-value">-10</span>
                        </div>
                        <div class="slider-group">
                            <label>c =</label>
                            <input type="range" class="slider" id="c2-slider" min="1" max="50" value="40" step="1">
                            <span class="slider-value" id="c2-value">40</span>
                        </div>
                    </div>
                    
                    <div class="demo-result">
                        <div class="math-display" id="quadratic-equation"></div>
                        <div class="math-display" id="discriminant-display"></div>
                        <div class="math-display" id="quadratic-roots"></div>
                        <div class="math-display" id="quadratic-explanation"></div>
                    </div>
                </div>
            </div>

            <!-- Summary Box -->
            <div class="summary-box">
                <h3>Key Insight</h3>
                <p><strong>Accepting the impossible:</strong> By defining i such that i² = -1, we can solve previously unsolvable equations.</p>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" onclick="switchTab('algebraic')">
                    Try Algebraic Explorer →
                </button>
                <button class="nav-btn" onclick="switchTab('geometric')">
                    Explore Geometry →
                </button>
            </div>
        </div>

        <!-- Algebraic Explorer Tab -->
        <div id="algebraic" class="tab-content">
            <div class="card">
                <h2>Algebraic Explorer</h2>
                <p>Master complex number arithmetic step by step</p>
            </div>

            <!-- Container 1: Worked Examples -->
            <div class="card">
                <h3>Worked Examples</h3>
                <p>Let's see how complex arithmetic works:</p>
                
                <div class="example-box">
                    <h4>Example 1: Multiplication</h4>
                    <div class="math-display" id="example1-problem"></div>
                    <div class="example-step" id="example1-step1"></div>
                    <div class="example-step" id="example1-step2"></div>
                    <div class="example-step" id="example1-step3"></div>
                    <div class="example-step" id="example1-result"></div>
                </div>
                
                <div class="example-box">
                    <h4>Example 2: Division</h4>
                    <div class="math-display" id="example2-problem"></div>
                    <div class="example-step" id="example2-step1"></div>
                    <div class="example-step" id="example2-step2"></div>
                    <div class="example-step" id="example2-result"></div>
                </div>
            </div>

            <!-- Container 2: Powers of i - Visual Unit Circle -->
            <div class="card">
                <h3>Powers of <em>i</em> on the Unit Circle</h3>
                <p>Watch how powers of <em>i</em> rotate around the circle, repeating every 4 steps:</p>
                
                <div class="power-display" id="current-power-display"></div>
                
                <div class="unit-circle-container">
                    <div class="unit-circle-visual">
                        <canvas id="powers-circle" width="300" height="300"></canvas>
                    </div>
                    <div class="powers-list">
                        <div id="powers-display"></div>
                    </div>
                </div>
                
                <div class="demo-controls" style="margin-top: 20px;">
                    <div class="slider-group">
                        <label>Power:</label>
                        <input type="range" class="slider" id="power-slider" min="-8" max="12" value="0" step="1">
                        <span class="slider-value" id="power-value">0</span>
                    </div>
                    <button class="demo-button" onclick="animatePowers()">Animate Cycle</button>
                </div>
            </div>

            <!-- Container 3: Create Your Own Problems -->
            <div class="card">
                <h3>Create Your Own Problem</h3>
                <p>Choose an operation type and I'll create numbers for you to work with:</p>
                
                <div class="preset-pills">
                    <button class="preset-pill" onclick="generateProblem('add')">Addition</button>
                    <button class="preset-pill" onclick="generateProblem('multiply')">Multiplication</button>
                    <button class="preset-pill" onclick="generateProblem('divide')">Division</button>
                    <button class="preset-pill" onclick="generateProblem('power')">Powers</button>
                    <button class="preset-pill" onclick="generateProblem('combined')">Combined Operations</button>
                </div>
                
                <div style="margin-top: 16px;">
                    <div class="math-display" id="generated-problem"></div>
                    <input type="text" class="user-answer-input" id="generated-answer" 
                           placeholder="Enter your answer in form a + bi">
                    <button class="demo-button" onclick="checkGeneratedAnswer()">Check Answer</button>
                    <div id="generated-feedback"></div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="summary-box">
                <h3>Key Insights</h3>
                <p><strong>1. Algebra stays the same:</strong> All the algebraic rules you already know still apply. The only new rule is that i² = -1.</p>
                <p><strong>2. Powers reveal geometry:</strong> The powers of i rotate around the unit circle, connecting algebra to geometry in a beautiful way.</p>
            </div>
        </div>

        <!-- Geometric View Tab -->
        <div id="geometric" class="tab-content">
            <div class="card">
                <h2>Multiplication in Two Forms</h2>
                
                <div class="info-box">
                    <h4>Rectangular Form</h4>
                    <div id="rect-mult-formula"></div>
                    <p>Expand using FOIL and simplify with i² = -1</p>
                </div>
                
                <div class="info-box">
                    <h4>Polar Form</h4>
                    <div id="polar-mult-formula"></div>
                    <p>Multiply magnitudes, add angles - revealing rotation and scaling!</p>
                </div>
            </div>

            <div class="card">
                <h2>Division in Two Forms</h2>
                
                <div class="info-box">
                    <h4>Rectangular Form</h4>
                    <div id="rect-div-formula"></div>
                    <p>Multiply by the conjugate of the denominator</p>
                </div>
                
                <div class="info-box">
                    <h4>Polar Form</h4>
                    <div id="polar-div-formula"></div>
                    <p>Divide magnitudes, subtract angles - the opposite of multiplication!</p>
                </div>
            </div>

            <div class="card">
                <h2>See Operations in Action</h2>
                <p>Watch how complex multiplication and division transform shapes!</p>
                
                <div class="geometric-controls">
                    <div class="number-input-group">
                        <label>Multiply by:</label>
                        <input type="text" class="number-input" id="multiply-by" value="2+i" placeholder="e.g., 2+i">
                        <button class="demo-button" onclick="multiplyShape()" style="margin-top: 8px;">Apply Multiplication</button>
                    </div>
                    <div class="number-input-group">
                        <label>Divide by:</label>
                        <input type="text" class="number-input" id="divide-by" value="1-i" placeholder="e.g., 1-i">
                        <button class="demo-button" onclick="divideShape()" style="margin-top: 8px;">Apply Division</button>
                    </div>
                </div>
                
                <canvas id="geometric-plane" width="500" height="500"></canvas>
                
                <div class="plane-controls">
                    <button class="control-button" onclick="resetShape()">Reset Shape</button>
                </div>
                
                <div id="operation-explanation" style="margin-top: 20px; text-align: center; font-weight: 600; color: #0f766e;"></div>
            </div>

            <!-- Key Insights -->
            <div class="summary-box">
                <h3>Key Insights</h3>
                <p><strong>Multiplication:</strong> Scales by |z₁||z₂| and rotates by θ₁ + θ₂</p>
                <p><strong>Division:</strong> Scales by |z₁|/|z₂| and rotates by θ₁ - θ₂</p>
                <p>Complex arithmetic is geometric transformation!</p>
            </div>
        </div>

        <!-- Exploration Tab -->
        <div id="exploration" class="tab-content">
            <div class="card">
                <h2>Which Form to Use?</h2>
                
                <div class="problem-selector">
                    <h3>Problem: <span id="exploration-problem"></span></h3>
                    <p>Think about which approach would be more convenient: rectangular (a + bi) or polar r(cos θ + i sin θ)?</p>
                    
                    <div class="button-row">
                        <button class="demo-button" onclick="showBothApproaches()">See Both Approaches</button>
                        <button class="control-button" onclick="nextExplorationProblem()">Try Another Problem</button>
                    </div>
                    
                    <div id="approach-comparison" style="display:none; margin-top: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="example-box">
                                <h4>Rectangular Approach</h4>
                                <div id="rect-approach"></div>
                            </div>
                            <div class="example-box">
                                <h4>Polar Approach</h4>
                                <div id="polar-approach"></div>
                            </div>
                        </div>
                        <div class="feedback-box correct" style="margin-top: 16px;">
                            <p id="approach-feedback"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Finding Roots: <span id="roots-equation"></span></h2>
                <p>Find all solutions when z raised to a power equals a complex number</p>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label>n = </label>
                            <input type="number" id="n-value" value="3" min="2" max="8" 
                                   style="width: 60px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;"
                                   onchange="updateRootsDisplay()">
                        </div>
                        <div>
                            <label>c = </label>
                            <input type="text" id="c-value" value="8" placeholder="e.g., 8 or 1+i"
                                   style="width: 100px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;"
                                   onchange="updateRootsDisplay()">
                        </div>
                        <button class="demo-button" onclick="findRoots()">
                            Find All Roots
                        </button>
                    </div>
                </div>
                
                <div id="roots-result" style="display:none; margin-top: 20px;">
                    <div class="example-box">
                        <h4>All Solutions</h4>
                        <div id="roots-list"></div>
                    </div>
                    <canvas id="roots-plane" width="350" height="350" style="margin-top: 20px;"></canvas>
                </div>
            </div>

            <!-- Key Insight -->
            <div class="summary-box">
                <h3>Key Insight</h3>
                <p>If <span id="root-equation-display"></span> where c has modulus r and angle θ, then:</p>
                <p>• Each root has modulus <span id="nth-root-r"></span></p>
                <p>• The n roots have angles: <span id="angle-formula"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'introduction';
        let generatedProblem = '';
        let generatedAnswer = '';
        let currentSolution = '';
        let shapePoints = [];
        let explorationProblems = [
            {problem: '(2+3i) + (1-2i)', bestForm: 'rectangular', type: 'addition'},
            {problem: '(1+i)^{10}', bestForm: 'polar', type: 'power'},
            {problem: '\\frac{3+4i}{1-i}', bestForm: 'both', type: 'division'},
            {problem: '(2-i) - (3+2i)', bestForm: 'rectangular', type: 'subtraction'},
            {problem: '(1+i)^5 \\cdot (1-i)^3', bestForm: 'polar', type: 'combined'}
        ];
        let currentExplorationIndex = 0;
        let powerAnimationId = null;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Introduction tab formulas
            katex.render("i^2 = -1", document.getElementById('i-definition'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("z = a + bi", document.getElementById('complex-form'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("x^2 + c", document.getElementById('factor-header'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Algebraic tab
            showWorkedExamples();
            initPowersCircle();
            updatePowerDisplay(0);
            
            // Geometric tab
            showGeometricFormulas();
            initGeometricPlane();
            
            // Exploration tab
            loadExplorationProblem();
            updateRootsDisplay();
            
            // Initialize displays
            updateFactoring();
            updateQuadratic();
            
            // Add slider listeners
            document.getElementById('c-slider').addEventListener('input', updateFactoring);
            document.getElementById('b-slider').addEventListener('input', updateQuadratic);
            document.getElementById('c2-slider').addEventListener('input', updateQuadratic);
            document.getElementById('power-slider').addEventListener('input', function() {
                const power = parseInt(this.value);
                document.getElementById('power-value').textContent = power;
                updatePowerDisplay(power);
            });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
        }

        // Add tab button listeners
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Introduction tab functions
        function updateFactoring() {
            const c = parseInt(document.getElementById('c-slider').value);
            document.getElementById('c-value').textContent = c;
            
            const factorDisplay = document.getElementById('factor-display');
            const rootsDisplay = document.getElementById('factor-roots');
            
            let factorLatex, rootsLatex;
            
            if (c > 0) {
                const sqrtC = Math.sqrt(c);
                let rootStr;
                if (Number.isInteger(sqrtC)) {
                    rootStr = sqrtC.toString();
                } else {
                    rootStr = `\\sqrt{${c}}`;
                }
                
                factorLatex = `x^2 + ${c} = \\left(x + ${rootStr}i\\right)\\left(x - ${rootStr}i\\right)`;
                rootsLatex = `\\text{Roots: } x = \\pm ${rootStr}i`;
            } else if (c < 0) {
                const absC = Math.abs(c);
                const sqrtAbsC = Math.sqrt(absC);
                let rootStr;
                if (Number.isInteger(sqrtAbsC)) {
                    rootStr = sqrtAbsC.toString();
                } else {
                    rootStr = `\\sqrt{${absC}}`;
                }
                
                factorLatex = `x^2 - ${absC} = \\left(x + ${rootStr}\\right)\\left(x - ${rootStr}\\right)`;
                rootsLatex = `\\text{Roots: } x = \\pm ${rootStr}`;
            } else {
                factorLatex = `x^2 = x \\cdot x`;
                rootsLatex = `\\text{Root: } x = 0 \\text{ (double root)}`;
            }
            
            katex.render(factorLatex, factorDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render(rootsLatex, rootsDisplay, {
                displayMode: false,
                throwOnError: false
            });
        }

        function updateQuadratic() {
            const b = parseInt(document.getElementById('b-slider').value);
            const c = parseInt(document.getElementById('c2-slider').value);
            document.getElementById('b-value').textContent = b;
            document.getElementById('c2-value').textContent = c;
            
            const equationDisplay = document.getElementById('quadratic-equation');
            const discriminantDisplay = document.getElementById('discriminant-display');
            const rootsDisplay = document.getElementById('quadratic-roots');
            const explanationDisplay = document.getElementById('quadratic-explanation');
            
            const bStr = b === 0 ? '' : (b > 0 ? `+ ${b}x` : `- ${Math.abs(b)}x`);
            const cStr = c === 0 ? '' : (c > 0 ? `+ ${c}` : `- ${Math.abs(c)}`);
            const eqLatex = `x^2 ${bStr} ${cStr} = 0`;
            
            katex.render(eqLatex, equationDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            const disc = b * b - 4 * c;
            let discLatex = `\\text{Discriminant: } b^2 - 4ac = ${disc}`;
            
            katex.render(discLatex, discriminantDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            let rootsLatex;
            let explanationLatex = '';
            
            if (disc < 0) {
                const absDisc = Math.abs(disc);
                const sqrtAbsDisc = Math.sqrt(absDisc);
                
                explanationLatex = `\\text{Since discriminant is negative, we use } \\sqrt{${absDisc}} \\cdot i`;
                
                if (Number.isInteger(sqrtAbsDisc) && sqrtAbsDisc % 2 === 0) {
                    const realPart = -b / 2;
                    const imagPart = sqrtAbsDisc / 2;
                    rootsLatex = `x = ${realPart} \\pm ${imagPart}i`;
                } else if (Number.isInteger(absDisc)) {
                    rootsLatex = `x = \\frac{${-b} \\pm \\sqrt{${absDisc}} \\cdot i}{2}`;
                } else {
                    const realPart = (-b / 2).toFixed(2);
                    const imagPart = (sqrtAbsDisc / 2).toFixed(2);
                    rootsLatex = `x = ${realPart} \\pm ${imagPart}i`;
                }
            } else if (disc > 0) {
                const sqrtDisc = Math.sqrt(disc);
                if (Number.isInteger(sqrtDisc)) {
                    const root1 = (-b + sqrtDisc) / 2;
                    const root2 = (-b - sqrtDisc) / 2;
                    rootsLatex = `x = ${root1}, ${root2}`;
                } else if (Number.isInteger(disc)) {
                    rootsLatex = `x = \\frac{${-b} \\pm \\sqrt{${disc}}}{2}`;
                } else {
                    const root1 = ((-b + sqrtDisc) / 2).toFixed(2);
                    const root2 = ((-b - sqrtDisc) / 2).toFixed(2);
                    rootsLatex = `x = ${root1}, ${root2}`;
                }
                explanationLatex = `\\text{Discriminant is positive, so we have two real roots}`;
            } else {
                const root = -b / 2;
                rootsLatex = `x = ${root}`;
                explanationLatex = `\\text{Discriminant is zero, so we have one repeated root}`;
            }
            
            katex.render(rootsLatex, rootsDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            if (explanationLatex) {
                katex.render(explanationLatex, explanationDisplay, {
                    displayMode: false,
                    throwOnError: false
                });
            }
        }

        // Algebraic Explorer functions
        function showWorkedExamples() {
            // Example 1: Multiplication
            katex.render("(2+3i)(1-i)", document.getElementById('example1-problem'), {
                displayMode: true,
                throwOnError: false
            });
            
            katex.render("= 2 \\cdot 1 + 2 \\cdot (-i) + 3i \\cdot 1 + 3i \\cdot (-i)", 
                document.getElementById('example1-step1'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("= 2 - 2i + 3i - 3i^2", document.getElementById('example1-step2'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("= 2 - 2i + 3i - 3(-1) = 2 + i + 3", document.getElementById('example1-step3'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("= 5 + i", document.getElementById('example1-result'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Example 2: Division
            katex.render("\\frac{3+2i}{1-i}", document.getElementById('example2-problem'), {
                displayMode: true,
                throwOnError: false
            });
            
            katex.render("\\text{Multiply by } \\frac{1+i}{1+i}: \\quad \\frac{(3+2i)(1+i)}{(1-i)(1+i)}", 
                document.getElementById('example2-step1'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("= \\frac{3 + 3i + 2i + 2i^2}{1 - i^2} = \\frac{3 + 5i - 2}{1 + 1} = \\frac{1 + 5i}{2}", 
                document.getElementById('example2-step2'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("= \\frac{1}{2} + \\frac{5}{2}i", document.getElementById('example2-result'), {
                displayMode: false,
                throwOnError: false
            });
        }

        function initPowersCircle() {
            const canvas = document.getElementById('powers-circle');
            if (!canvas) return;
            drawPowerCircle(0);
        }

        function drawPowerCircle(power) {
            const canvas = document.getElementById('powers-circle');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 100;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(centerX - radius - 20, centerY);
            ctx.lineTo(centerX + radius + 20, centerY);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - radius - 20);
            ctx.lineTo(centerX, centerY + radius + 20);
            ctx.stroke();
            
            // Draw unit circle
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Mark the four key positions
            const positions = [
                {x: radius, y: 0, label: '1', power: 0},
                {x: 0, y: -radius, label: 'i', power: 1},
                {x: -radius, y: 0, label: '-1', power: 2},
                {x: 0, y: radius, label: '-i', power: 3}
            ];
            
            positions.forEach((pos, idx) => {
                const x = centerX + pos.x;
                const y = centerY + pos.y;
                
                // Draw point
                ctx.fillStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#4b5563';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const labelX = x + (pos.x === 0 ? 0 : pos.x > 0 ? 20 : -20);
                const labelY = y + (pos.y === 0 ? 0 : pos.y > 0 ? 20 : -20);
                ctx.fillText(pos.label, labelX, labelY);
            });
            
            // Calculate position for current power
            const normalizedPower = ((power % 4) + 4) % 4;
            const currentPos = positions[normalizedPower];
            const currentX = centerX + currentPos.x;
            const currentY = centerY + currentPos.y;
            
            // Draw vector from origin
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            // Draw highlighted point
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
            ctx.fill();
        }

        function updatePowerDisplay(power) {
            drawPowerCircle(power);
            
            // Update the big display at the top
            const currentPowerDisplay = document.getElementById('current-power-display');
            const values = ['1', 'i', '-1', '-i'];
            const normalizedPower = ((power % 4) + 4) % 4;
            katex.render(`i^{${power}} = ${values[normalizedPower]}`, currentPowerDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            // Update the list of powers
            const powersDisplay = document.getElementById('powers-display');
            let html = '<div style="text-align: left;">';
            
            // Show a range of powers including negative
            for (let i = -4; i <= 8; i++) {
                const value = values[((i % 4) + 4) % 4];
                const isBold = i === power;
                const style = isBold ? 'font-weight: bold; color: #0f766e;' : '';
                html += `<div style="${style}" id="power-${i}"></div>`;
            }
            html += '</div>';
            
            powersDisplay.innerHTML = html;
            
            // Render each power
            for (let i = -4; i <= 8; i++) {
                const value = values[((i % 4) + 4) % 4];
                const elem = document.getElementById(`power-${i}`);
                if (elem) {
                    katex.render(`i^{${i}} = ${value}`, elem, {
                        displayMode: false,
                        throwOnError: false
                    });
                }
            }
        }

        function animatePowers() {
            if (powerAnimationId) {
                clearInterval(powerAnimationId);
                powerAnimationId = null;
                return;
            }
            
            let currentPower = 0;
            powerAnimationId = setInterval(() => {
                currentPower = (currentPower + 1) % 8;
                document.getElementById('power-slider').value = currentPower;
                document.getElementById('power-value').textContent = currentPower;
                updatePowerDisplay(currentPower);
                
                if (currentPower === 7) {
                    clearInterval(powerAnimationId);
                    powerAnimationId = null;
                }
            }, 500);
        }

        function formatComplexNumber(real, imag) {
            // Format complex numbers properly
            if (imag === 0) return real.toString();
            if (real === 0) {
                if (imag === 1) return 'i';
                if (imag === -1) return '-i';
                return `${imag}i`;
            }
            if (imag === 1) return `${real}+i`;
            if (imag === -1) return `${real}-i`;
            return `${real}${imag >= 0 ? '+' : ''}${imag}i`;
        }

        function generateProblem(operation) {
            let a = Math.floor(Math.random() * 5) - 2;
            let b = Math.floor(Math.random() * 5) - 2;
            let c = Math.floor(Math.random() * 5) - 2;
            let d = Math.floor(Math.random() * 5) - 2;
            
            // Avoid division by zero
            if (operation === 'divide' && c === 0 && d === 0) {
                c = 1;
            }
            
            let problemText = '';
            let answer = '';
            let solution = '';
            
            if (operation === 'add') {
                const z1 = formatComplexNumber(a, b);
                const z2 = formatComplexNumber(c, d);
                problemText = `(${z1}) + (${z2})`;
                const realPart = a + c;
                const imagPart = b + d;
                answer = formatComplexNumber(realPart, imagPart);
                solution = `Add real parts: ${a} + ${c} = ${realPart}\nAdd imaginary parts: ${b} + ${d} = ${imagPart}\nResult: ${answer}`;
            } else if (operation === 'multiply') {
                const z1 = formatComplexNumber(a, b);
                const z2 = formatComplexNumber(c, d);
                problemText = `(${z1})(${z2})`;
                const realPart = a*c - b*d;
                const imagPart = a*d + b*c;
                answer = formatComplexNumber(realPart, imagPart);
                solution = `FOIL: (${a})(${c}) + (${a})(${d}i) + (${b}i)(${c}) + (${b}i)(${d}i)\n= ${a*c} + ${a*d}i + ${b*c}i + ${b*d}i²\n= ${a*c} + ${a*d + b*c}i - ${b*d}\n= ${answer}`;
            } else if (operation === 'divide') {
                const z1 = formatComplexNumber(a, b);
                const z2 = formatComplexNumber(c, d);
                problemText = `\\frac{${z1}}{${z2}}`;
                const denom = c*c + d*d;
                const realPart = (a*c + b*d) / denom;
                const imagPart = (b*c - a*d) / denom;
                answer = formatComplexNumber(parseFloat(realPart.toFixed(2)), parseFloat(imagPart.toFixed(2)));
                solution = `Multiply by conjugate: \\frac{(${z1})(${formatComplexNumber(c, -d)})}{(${z2})(${formatComplexNumber(c, -d)})}\n= \\frac{${a*c + b*d} + ${b*c - a*d}i}{${denom}}\n= ${answer}`;
            } else if (operation === 'power') {
                const n = Math.floor(Math.random() * 3) + 2;
                const z = formatComplexNumber(a, b);
                problemText = `(${z})^{${n}}`;
                answer = 'Calculate step by step';
                solution = 'Square first, then multiply by original if n=3';
            } else if (operation === 'combined') {
                const z1 = formatComplexNumber(1, 1);
                const z2 = formatComplexNumber(1, -1);
                problemText = `\\frac{(${z1})^2}{${z2}}`;
                answer = formatComplexNumber(-2, -2);
                solution = `First: (1+i)² = 1 + 2i + i² = 1 + 2i - 1 = 2i\nThen: \\frac{2i}{1-i} × \\frac{1+i}{1+i} = \\frac{2i(1+i)}{2} = \\frac{2i + 2i²}{2} = \\frac{2i - 2}{2} = -1 + i`;
            }
            
            generatedProblem = problemText;
            generatedAnswer = answer;
            currentSolution = solution;
            
            katex.render(problemText, document.getElementById('generated-problem'), {
                displayMode: true,
                throwOnError: false
            });
            
            document.getElementById('generated-answer').value = '';
            document.getElementById('generated-feedback').innerHTML = '';
        }

        function normalizeAnswer(answer) {
            // Remove spaces and normalize format
            return answer.replace(/\s/g, '').replace(/\+-/g, '-').replace(/--/g, '+');
        }

        function checkGeneratedAnswer() {
            const userAnswer = document.getElementById('generated-answer').value;
            const feedback = document.getElementById('generated-feedback');
            
            if (!userAnswer) {
                feedback.innerHTML = '<div class="feedback-box peer">Please enter your answer to compare.</div>';
                return;
            }
            
            if (generatedAnswer === 'Calculate step by step') {
                feedback.innerHTML = `
                    <div class="feedback-box peer">
                        My answer is: <strong>${userAnswer}</strong>
                        <br>Would you like to see my solution?
                        <div class="peer-buttons">
                            <button class="peer-btn show-solution-btn" onclick="showMySolution()">Yes, show me</button>
                            <button class="peer-btn agree-btn" onclick="moveToNext()">No, let's continue</button>
                        </div>
                    </div>`;
            } else {
                const normalized = normalizeAnswer(userAnswer);
                const expectedNorm = normalizeAnswer(generatedAnswer);
                
                if (normalized === expectedNorm) {
                    feedback.innerHTML = '<div class="feedback-box correct">We got the same answer! Shall we move to another problem?</div>';
                } else {
                    feedback.innerHTML = `
                        <div class="feedback-box peer">
                            My answer is: <strong>${generatedAnswer}</strong>
                            <br>Your answer is: <strong>${userAnswer}</strong>
                            <br>Would you like to see my solution?
                            <div class="peer-buttons">
                                <button class="peer-btn show-solution-btn" onclick="showMySolution()">Yes, show me</button>
                                <button class="peer-btn challenge-btn" onclick="challengeSolution()">I think mine is right</button>
                            </div>
                        </div>`;
                }
            }
        }

        function showMySolution() {
            const feedback = document.getElementById('generated-feedback');
            feedback.innerHTML += `
                <div class="solution-box">
                    <h4>My Solution:</h4>
                    <pre>${currentSolution}</pre>
                    <div class="peer-buttons">
                        <button class="peer-btn agree-btn" onclick="moveToNext()">I see, shall we continue?</button>
                        <button class="peer-btn challenge-btn" onclick="challengeSolution()">I still think my answer is right</button>
                    </div>
                </div>`;
        }

        function challengeSolution() {
            const feedback = document.getElementById('generated-feedback');
            const userAnswer = document.getElementById('generated-answer').value;
            feedback.innerHTML += `
                <div class="feedback-box peer">
                    Interesting! Let's both check our work again. Sometimes there are equivalent forms or one of us might have made an arithmetic error.
                    <br>Your answer: <strong>${userAnswer}</strong> might be correct too!
                    <br>Shall we move to another problem?
                    <div class="peer-buttons">
                        <button class="peer-btn agree-btn" onclick="moveToNext()">Yes, let's continue</button>
                    </div>
                </div>`;
        }

        function moveToNext() {
            document.getElementById('generated-problem').innerHTML = '';
            document.getElementById('generated-answer').value = '';
            document.getElementById('generated-feedback').innerHTML = '<div class="feedback-box correct">Great! Choose another operation type above to practice more.</div>';
        }

        // Geometric View functions
        function showGeometricFormulas() {
            // Multiplication - Rectangular
            katex.render("(a+bi)(c+di) = (ac-bd) + (ad+bc)i", 
                document.getElementById('rect-mult-formula'), {
                displayMode: true,
                throwOnError: false
            });
            
            // Multiplication - Polar
            katex.render("r_1(\\cos\\theta_1 + i\\sin\\theta_1) \\cdot r_2(\\cos\\theta_2 + i\\sin\\theta_2) = r_1r_2(\\cos(\\theta_1+\\theta_2) + i\\sin(\\theta_1+\\theta_2))", 
                document.getElementById('polar-mult-formula'), {
                displayMode: true,
                throwOnError: false
            });
            
            // Division - Rectangular
            katex.render("\\frac{a+bi}{c+di} = \\frac{(a+bi)(c-di)}{(c+di)(c-di)} = \\frac{(ac+bd) + (bc-ad)i}{c^2+d^2}", 
                document.getElementById('rect-div-formula'), {
                displayMode: true,
                throwOnError: false
            });
            
            // Division - Polar
            katex.render("\\frac{r_1(\\cos\\theta_1 + i\\sin\\theta_1)}{r_2(\\cos\\theta_2 + i\\sin\\theta_2)} = \\frac{r_1}{r_2}(\\cos(\\theta_1-\\theta_2) + i\\sin(\\theta_1-\\theta_2))", 
                document.getElementById('polar-div-formula'), {
                displayMode: true,
                throwOnError: false
            });
        }

        function initGeometricPlane() {
            drawShape();
        }

        function drawShape() {
            const canvas = document.getElementById('geometric-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -5; i <= 5; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw smiley face
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 3;
            
            // Face circle
            ctx.beginPath();
            ctx.arc(centerX + 2*scale, centerY - 2*scale, scale, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Eyes
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(centerX + 1.5*scale, centerY - 2.5*scale, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 2.5*scale, centerY - 2.5*scale, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // Smile
            ctx.strokeStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(centerX + 2*scale, centerY - 2*scale, 0.6*scale, 0, Math.PI);
            ctx.stroke();
            
            // Store shape center for transformations
            shapePoints = [{x: 2, y: 2}]; // Center of smiley
        }

        function parseComplex(str) {
            // Parse a complex number string
            str = str.replace(/\s/g, '');
            
            // Check for just 'i'
            if (str === 'i') return {real: 0, imag: 1};
            if (str === '-i') return {real: 0, imag: -1};
            
            // Check for pure real
            if (!str.includes('i')) {
                const real = parseFloat(str);
                return {real: isNaN(real) ? 1 : real, imag: 0};
            }
            
            // Check for pure imaginary
            if (/^[+-]?\d*\.?\d*i$/.test(str)) {
                const imagStr = str.replace('i', '');
                let imag = parseFloat(imagStr);
                if (imagStr === '' || imagStr === '+') imag = 1;
                if (imagStr === '-') imag = -1;
                return {real: 0, imag};
            }
            
            // Full complex number
            const match = str.match(/^([+-]?\d*\.?\d+)([+-]\d*\.?\d*)i$/);
            if (match) {
                const real = parseFloat(match[1]);
                let imagStr = match[2];
                let imag = parseFloat(imagStr);
                if (imagStr === '+' || imagStr === '') imag = 1;
                if (imagStr === '-') imag = -1;
                return {real, imag};
            }
            
            return {real: 1, imag: 0}; // default
        }

        function multiplyShape() {
            const input = document.getElementById('multiply-by').value;
            const z = parseComplex(input);
            
            const canvas = document.getElementById('geometric-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;
            
            // Clear and redraw
            drawShape();
            
            // Calculate transformation
            const r = Math.sqrt(z.real * z.real + z.imag * z.imag);
            const theta = Math.atan2(z.imag, z.real) * 180 / Math.PI;
            
            // Transform smiley center
            const newX = 2 * z.real - 2 * z.imag;
            const newY = 2 * z.imag + 2 * z.real;
            const newRadius = scale * r;
            
            // Draw transformed smiley
            ctx.strokeStyle = '#0f766e';
            ctx.lineWidth = 3;
            
            // Face
            ctx.beginPath();
            ctx.arc(centerX + newX * scale, centerY - newY * scale, newRadius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Eyes (transformed)
            const eyeAngle = Math.atan2(z.imag, z.real);
            const leftEyeX = newX - 0.5 * r * Math.cos(eyeAngle);
            const leftEyeY = newY - 0.5 * r * Math.sin(eyeAngle);
            const rightEyeX = newX + 0.5 * r * Math.cos(eyeAngle);
            const rightEyeY = newY + 0.5 * r * Math.sin(eyeAngle);
            
            ctx.fillStyle = '#0f766e';
            ctx.beginPath();
            ctx.arc(centerX + leftEyeX * scale, centerY - leftEyeY * scale, 5 * r, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + rightEyeX * scale, centerY - rightEyeY * scale, 5 * r, 0, 2 * Math.PI);
            ctx.fill();
            
            // Update explanation
            const explanation = document.getElementById('operation-explanation');
            explanation.innerHTML = `Multiplication by ${input}: Scales by ${r.toFixed(2)} and rotates by ${theta.toFixed(1)}°`;
        }

        function divideShape() {
            const input = document.getElementById('divide-by').value;
            const z = parseComplex(input);
            
            // Avoid division by zero
            if (z.real === 0 && z.imag === 0) {
                document.getElementById('operation-explanation').innerHTML = 'Cannot divide by zero!';
                return;
            }
            
            const canvas = document.getElementById('geometric-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;
            
            // Clear and redraw
            drawShape();
            
            // Calculate inverse
            const denom = z.real * z.real + z.imag * z.imag;
            const invReal = z.real / denom;
            const invImag = -z.imag / denom;
            
            // Calculate transformation
            const r = Math.sqrt(z.real * z.real + z.imag * z.imag);
            const theta = Math.atan2(z.imag, z.real) * 180 / Math.PI;
            
            // Transform smiley center
            const newX = 2 * invReal - 2 * invImag;
            const newY = 2 * invImag + 2 * invReal;
            const newRadius = scale / r;
            
            // Draw transformed smiley
            ctx.strokeStyle = '#c62828';
            ctx.lineWidth = 3;
            
            // Face
            ctx.beginPath();
            ctx.arc(centerX + newX * scale, centerY - newY * scale, newRadius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Update explanation
            const explanation = document.getElementById('operation-explanation');
            explanation.innerHTML = `Division by ${input}: Scales by ${(1/r).toFixed(2)} and rotates by ${(-theta).toFixed(1)}°`;
        }

        function resetShape() {
            drawShape();
            document.getElementById('operation-explanation').innerHTML = '';
        }

        // Exploration functions
        function loadExplorationProblem() {
            const problem = explorationProblems[currentExplorationIndex];
            const display = document.getElementById('exploration-problem');
            
            katex.render(problem.problem, display, {
                displayMode: false,
                throwOnError: false
            });
        }

        function showBothApproaches() {
            const problem = explorationProblems[currentExplorationIndex];
            const comparison = document.getElementById('approach-comparison');
            const rectApproach = document.getElementById('rect-approach');
            const polarApproach = document.getElementById('polar-approach');
            const feedback = document.getElementById('approach-feedback');
            
            comparison.style.display = 'block';
            
            // Show different approaches based on problem type
            if (problem.type === 'addition') {
                rectApproach.innerHTML = '<p>Simply add components:<br>(2+3i) + (1-2i) = 3 + i<br>Quick and easy!</p>';
                polarApproach.innerHTML = '<p>Convert to polar, then...<br>Actually quite complicated!<br>Need to convert back to add.</p>';
                feedback.textContent = 'Rectangular form is clearly better for addition and subtraction!';
            } else if (problem.type === 'power') {
                rectApproach.innerHTML = '<p>Multiply 10 times:<br>(1+i)(1+i) = 2i<br>(2i)(1+i) = -2 + 2i<br>... many steps!</p>';
                polarApproach.innerHTML = '<p>Convert: 1+i = √2∠45°<br>Power: (√2)^10 ∠(10×45°)<br>= 32∠450° = 32∠90° = 32i<br>Much simpler!</p>';
                feedback.textContent = 'Polar form is much better for powers and roots!';
            } else if (problem.type === 'division') {
                rectApproach.innerHTML = '<p>Multiply by conjugate:<br>(3+4i)(1+i) / (1-i)(1+i)<br>= (3+3i+4i+4i²) / 2<br>= (-1+7i) / 2</p>';
                polarApproach.innerHTML = '<p>Convert both to polar<br>Divide magnitudes, subtract angles<br>Convert back if needed</p>';
                feedback.textContent = 'Both methods work well for division - choose based on the numbers!';
            } else if (problem.type === 'combined') {
                rectApproach.innerHTML = '<p>Work through step by step<br>Many calculations needed<br>Easy to make errors</p>';
                polarApproach.innerHTML = '<p>Convert to polar first<br>Powers become simple<br>Multiply/divide magnitudes and add/subtract angles</p>';
                feedback.textContent = 'For combined operations with powers, polar form often simplifies the work significantly!';
            }
        }

        function nextExplorationProblem() {
            currentExplorationIndex = (currentExplorationIndex + 1) % explorationProblems.length;
            loadExplorationProblem();
            document.getElementById('approach-comparison').style.display = 'none';
        }

        function updateRootsDisplay() {
            const n = document.getElementById('n-value').value;
            const c = document.getElementById('c-value').value;
            
            const eqDisplay = document.getElementById('roots-equation');
            katex.render(`z^{${n}} = ${c}`, eqDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            const rootEqDisplay = document.getElementById('root-equation-display');
            katex.render(`z^{${n}} = c`, rootEqDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            const nthRootDisplay = document.getElementById('nth-root-r');
            katex.render(`\\sqrt[${n}]{r}`, nthRootDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            const angleDisplay = document.getElementById('angle-formula');
            katex.render(`\\frac{\\theta + 2\\pi k}{${n}} \\text{ for } k = 0, 1, ..., ${n-1}`, angleDisplay, {
                displayMode: false,
                throwOnError: false
            });
        }

        function findRoots() {
            const n = parseInt(document.getElementById('n-value').value);
            const cStr = document.getElementById('c-value').value;
            const resultDiv = document.getElementById('roots-result');
            const listDiv = document.getElementById('roots-list');
            
            resultDiv.style.display = 'block';
            
            // Parse c
            let c = parseComplex(cStr);
            if (!c.imag && !isNaN(parseFloat(cStr))) {
                c = {real: parseFloat(cStr), imag: 0};
            }
            
            // Calculate modulus and angle of c
            const r = Math.sqrt(c.real * c.real + c.imag * c.imag);
            const theta = Math.atan2(c.imag, c.real);
            
            // Calculate roots
            const rootR = Math.pow(r, 1/n);
            let rootsHtml = '';
            
            for (let k = 0; k < n; k++) {
                const angle = (theta + 2 * Math.PI * k) / n;
                const angleDeg = (angle * 180 / Math.PI).toFixed(0);
                const realPart = rootR * Math.cos(angle);
                const imagPart = rootR * Math.sin(angle);
                
                const formattedRoot = formatComplexNumber(
                    parseFloat(realPart.toFixed(2)), 
                    parseFloat(imagPart.toFixed(2))
                );
                
                rootsHtml += `<p>z_{${k}} = ${formattedRoot} \\quad (\\text{angle: } ${angleDeg}°)</p>`;
            }
            
            listDiv.innerHTML = rootsHtml;
            
            // Render all formulas
            listDiv.querySelectorAll('p').forEach(p => {
                const text = p.textContent;
                katex.render(text, p, {
                    displayMode: false,
                    throwOnError: false
                });
            });
            
            // Draw on canvas
            drawRootsPlane(n, rootR, theta);
        }

        function drawRootsPlane(n, rootR, theta) {
            const canvas = document.getElementById('roots-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = Math.min(100, 150 / rootR);
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw circle at radius rootR
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(centerX, centerY, rootR * scale, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw roots
            for (let k = 0; k < n; k++) {
                const angle = (theta + 2 * Math.PI * k) / n;
                const x = centerX + rootR * Math.cos(angle) * scale;
                const y = centerY - rootR * Math.sin(angle) * scale;
                
                // Draw line from origin
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw point
                ctx.fillStyle = '#0f766e';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#212121';
                ctx.font = '12px sans-serif';
                ctx.fillText(`z${k}`, x + 8, y - 8);
            }
            
            // Connect roots to form polygon
            if (n > 2) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                for (let k = 0; k <= n; k++) {
                    const angle = (theta + 2 * Math.PI * k) / n;
                    const x = centerX + rootR * Math.cos(angle) * scale;
                    const y = centerY - rootR * Math.sin(angle) * scale;
                    if (k === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }
    </script>
</body>
</html>
