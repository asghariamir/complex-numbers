<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Numbers - Mathswell</title>
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f7faf9;
            color: #212121;
            line-height: 1.6;
        }

        /* Mathswell Navigation */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: .75rem 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .mathswell-nav .mw-link {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            color: #0f766e;
            padding: .3rem .7rem;
            border-radius: 999px;
            background: rgba(255,255,255,.95);
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            transition: all 0.3s ease;
        }

        .mathswell-nav .mw-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,.12);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #4b5563;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #e6fffb;
        }

        .tab-button.active {
            background: #0f766e;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards and Sections */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .intro-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .intro-header h1 {
            font-size: 2.5em;
            color: #0f766e;
            margin-bottom: 8px;
        }

        .intro-header p {
            font-size: 1.2em;
            color: #4b5563;
        }

        .concept-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .concept-card {
            background: linear-gradient(135deg, #e6fffb 0%, #f0fffe 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .concept-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .concept-card h3 {
            color: #0f766e;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        /* Interactive Demo */
        .interactive-demo {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .demo-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .slider-group label {
            font-weight: 600;
            color: #4b5563;
            min-width: 30px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0f766e;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0f766e;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #0f766e;
        }

        .demo-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            background: #10b981;
            transform: translateY(-1px);
        }

        .demo-result {
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }

        .math-display {
            margin: 8px 0;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .nav-btn {
            padding: 14px 28px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #10b981;
            transform: translateX(4px);
        }

        /* Algebraic Explorer Styles */
        .expression-input-group {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .expression-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            margin-bottom: 16px;
        }

        .expression-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .user-answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
        }

        .user-answer-input:focus {
            outline: none;
            border-color: #10b981;
        }

        .preset-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .preset-pill {
            padding: 8px 16px;
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            color: #0f766e;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-pill:hover {
            background: #10b981;
            color: white;
        }

        .result-display {
            background: #e6fffb;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-display h3 {
            color: #0f766e;
            margin-bottom: 12px;
        }

        .feedback-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .feedback-box.match {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }

        .feedback-box.no-match {
            background: #fed7aa;
            border: 2px solid #fb923c;
            color: #9a3412;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .secondary-button {
            padding: 10px 20px;
            background: #4b5563;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .secondary-button:hover {
            background: #6b7280;
        }

        /* Complex Plane Canvas */
        .plane-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .geometry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .geometry-grid {
                grid-template-columns: 1fr;
            }
        }

        canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }

        .plane-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-button {
            padding: 10px 20px;
            background: #0f766e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #10b981;
        }

        .control-button.secondary {
            background: #4b5563;
        }

        .control-button.secondary:hover {
            background: #6b7280;
        }

        /* Info boxes */
        .info-box {
            background: #f0fffe;
            border-left: 4px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #0f766e;
            margin-bottom: 8px;
        }

        .representation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .rep-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .rep-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .rep-card h4 {
            color: #0f766e;
            margin-bottom: 8px;
        }

        /* Loading and AI status */
        .ai-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #e6fffb;
            border-radius: 999px;
            font-size: 13px;
            color: #0f766e;
            margin-left: 12px;
        }

        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #10b981;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            font-size: 14px;
            color: #92400e;
        }

        /* Equation solver specific */
        .roots-display {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }

        .root-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .root-value {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #0f766e;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .intro-header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
            }
            
            .geometry-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Mathswell Navigation -->
    <div class="mathswell-nav">
        <a href="/" class="mw-link">
            <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
            <span>MATHSWELL</span>
        </a>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="introduction">Introduction</button>
            <button class="tab-button" data-tab="algebraic">Algebraic Explorer</button>
            <button class="tab-button" data-tab="geometric">Geometric View</button>
            <button class="tab-button" data-tab="equations">Equation Solver</button>
        </div>

        <!-- Introduction Tab -->
        <div id="introduction" class="tab-content active">
            <div class="intro-header">
                <h1>Complex Numbers</h1>
                <p>Impossible numbers that create endless possibilities</p>
            </div>

            <!-- Concept Cards -->
            <div class="concept-cards">
                <div class="concept-card">
                    <h3>The Imaginary Unit <em>i</em></h3>
                    <p>We define <strong><em>i</em></strong> as something whose square is -1:</p>
                    <div class="math-display" id="i-definition"></div>
                    <p>This "impossible" idea unlocks a whole new mathematical universe!</p>
                </div>

                <div class="concept-card">
                    <h3>Complex Numbers: a + bi</h3>
                    <p>Every complex number combines real and imaginary parts:</p>
                    <div class="math-display" id="complex-form"></div>
                    <p>They follow all arithmetic rules, always simplifying to this form.</p>
                </div>

                <div class="concept-card">
                    <h3>Solving the Unsolvable</h3>
                    <p>When the discriminant is negative, we use complex numbers:</p>
                    <div class="math-display" id="discriminant-formula"></div>
                    <p>Every quadratic now has solutions!</p>
                </div>
            </div>

            <!-- Interactive Demo 1: Factoring x² + c -->
            <div class="interactive-demo">
                <h2>Factoring <span id="factor-header"></span></h2>
                <p>See how complex numbers let us factor any quadratic, even when c is positive!</p>
                
                <div class="demo-controls">
                    <div class="slider-group">
                        <label>c =</label>
                        <input type="range" class="slider" id="c-slider" min="-10" max="10" value="1" step="0.5">
                        <span class="slider-value" id="c-value">1</span>
                    </div>
                </div>
                
                <div class="demo-result">
                    <div class="math-display" id="factor-display"></div>
                    <div class="math-display" id="factor-roots"></div>
                </div>
            </div>

            <!-- Interactive Demo 2: Solving ax² + bx + c = 0 -->
            <div class="interactive-demo">
                <h2>Solving <span id="quadratic-header"></span></h2>
                <p>Adjust b and c to see how the discriminant affects the solutions:</p>
                
                <div class="demo-controls">
                    <div class="slider-group">
                        <label>b =</label>
                        <input type="range" class="slider" id="b-slider" min="-10" max="10" value="2" step="0.5">
                        <span class="slider-value" id="b-value">2</span>
                    </div>
                    <div class="slider-group">
                        <label>c =</label>
                        <input type="range" class="slider" id="c2-slider" min="-10" max="10" value="5" step="0.5">
                        <span class="slider-value" id="c2-value">5</span>
                    </div>
                </div>
                
                <div class="demo-result">
                    <div class="math-display" id="quadratic-equation"></div>
                    <div class="math-display" id="discriminant-display"></div>
                    <div class="math-display" id="quadratic-roots"></div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="card">
                <h2>Two Perspectives on Complex Numbers</h2>
                
                <div class="info-box">
                    <h4>1. Algebraic Perspective</h4>
                    <p>Complex numbers complete our number system. When the discriminant <span id="disc-formula"></span> is negative, 
                    we write <span id="neg-sqrt"></span>. This lets us solve any quadratic equation!</p>
                </div>
                
                <div class="info-box">
                    <h4>2. Geometric Perspective</h4>
                    <p>Complex numbers are points on a 2D plane. Addition moves points, multiplication rotates and scales them. 
                    This geometric view reveals beautiful patterns, especially in roots of unity.</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" onclick="switchTab('algebraic')">
                    Try Algebraic Explorer →
                </button>
                <button class="nav-btn" onclick="switchTab('geometric')">
                    Explore Geometry →
                </button>
                <button class="nav-btn" onclick="switchTab('equations')">
                    Solve Equations →
                </button>
            </div>
        </div>

        <!-- Algebraic Explorer Tab -->
        <div id="algebraic" class="tab-content">
            <div class="card">
                <h2>Algebraic Explorer</h2>
                <p>Practice transforming complex expressions into standard form a + bi</p>
                
                <div class="disclaimer">
                    ⚡ AI-powered checking - The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic
                </div>
            </div>

            <div class="expression-input-group">
                <h3>Complex Expression</h3>
                <input type="text" class="expression-input" id="complex-expression" 
                       placeholder="e.g., (2+3i)*(1-i) or (1+i)^3" 
                       value="(2+3i)*(1-i)">
                
                <div class="preset-pills">
                    <button class="preset-pill" onclick="setExpression('(3+2i) + (1-4i)')">Addition</button>
                    <button class="preset-pill" onclick="setExpression('(2+3i) * (1-i)')">Multiplication</button>
                    <button class="preset-pill" onclick="setExpression('(3+2i) / (1-i)')">Division</button>
                    <button class="preset-pill" onclick="setExpression('(1+i)^4')">Powers: (1+i)⁴</button>
                    <button class="preset-pill" onclick="setExpression('i^17')">Powers of i: i¹⁷</button>
                    <button class="preset-pill" onclick="setExpression('((2+i)*(3-2i))/(1+i)')">Complex</button>
                </div>
                
                <h4 style="margin-top: 20px;">Your Answer (in form a + bi):</h4>
                <input type="text" class="user-answer-input" id="user-answer" 
                       placeholder="Enter your answer, e.g., 5 + i or 3 - 2i">
                
                <div class="button-group">
                    <button class="demo-button" onclick="checkAnswer()">
                        Check Answer <span class="ai-status" id="ai-status" style="display:none;"><span class="loading-spinner"></span> Checking...</span>
                    </button>
                    <button class="secondary-button" onclick="challengeAI()" id="challenge-btn" style="display:none;">
                        Challenge AI's Answer
                    </button>
                </div>
            </div>

            <div class="result-display" id="algebraic-result" style="display:none;">
                <h3>Feedback</h3>
                <div id="feedback-content"></div>
                <div id="steps-container" style="display:none; margin-top: 16px;">
                    <h4>Solution Steps</h4>
                    <div id="solution-steps"></div>
                </div>
            </div>
        </div>

        <!-- Geometric View Tab -->
        <div id="geometric" class="tab-content">
            <div class="card">
                <h2>Complex Number Representations</h2>
                <div class="representation-cards">
                    <div class="rep-card">
                        <h4>Rectangular: a + bi</h4>
                        <p>Best for addition and subtraction. Components add directly: (a+bi) + (c+di) = (a+c) + (b+d)i</p>
                    </div>
                    <div class="rep-card">
                        <h4>Polar: r(cos θ + i sin θ)</h4>
                        <p>Best for multiplication and division. Multiply magnitudes, add angles: <span id="polar-mult"></span></p>
                    </div>
                    <div class="rep-card">
                        <h4>Exponential: <span id="exp-form"></span></h4>
                        <p>Most elegant for multiplication. Product rule becomes obvious: <span id="exp-mult"></span></p>
                    </div>
                </div>
            </div>

            <div class="geometry-grid">
                <!-- Addition/Subtraction Plane -->
                <div class="plane-container">
                    <h3>Addition & Subtraction</h3>
                    <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">
                        Addition is translation: we add components separately. Click to add numbers, then see their sum or difference.
                    </p>
                    <canvas id="addition-plane" width="350" height="350"></canvas>
                    <div class="plane-controls">
                        <button class="control-button" onclick="addNumberToAdditionPlane()">Add Random</button>
                        <button class="control-button" onclick="showAddition()">Show Sum</button>
                        <button class="control-button" onclick="showSubtraction()">Show Difference</button>
                        <button class="control-button secondary" onclick="clearAdditionPlane()">Clear</button>
                    </div>
                    <div id="addition-info" style="margin-top: 12px; text-align: center; font-size: 14px; word-wrap: break-word;"></div>
                </div>

                <!-- Multiplication/Division Plane -->
                <div class="plane-container">
                    <h3>Multiplication & Division</h3>
                    <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">
                        Multiplication rotates and scales: angles add, magnitudes multiply. Division subtracts angles, divides magnitudes.
                    </p>
                    <canvas id="multiplication-plane" width="350" height="350"></canvas>
                    <div class="plane-controls">
                        <button class="control-button" onclick="addNumberToMultPlane()">Add Random</button>
                        <button class="control-button" onclick="showMultiplication()">Show Product</button>
                        <button class="control-button" onclick="showDivision()">Show Quotient</button>
                        <button class="control-button secondary" onclick="clearMultPlane()">Clear</button>
                    </div>
                    <div id="mult-info" style="margin-top: 12px; text-align: center; font-size: 14px; word-wrap: break-word;"></div>
                </div>
            </div>

            <div class="info-box">
                <h4>Key Insight: Why Different Forms?</h4>
                <p>The rectangular form (a + bi) makes addition natural because we just add components. 
                But for multiplication, the exponential form <span id="exp-form2"></span> reveals the true structure: 
                multiplying by <span id="exp-theta"></span> is pure rotation by angle θ, and multiplying by r scales the magnitude. 
                This is why complex multiplication creates spirals and rotations!</p>
            </div>
        </div>

        <!-- Equation Solver Tab -->
        <div id="equations" class="tab-content">
            <div class="card">
                <h2>Complex Equation Solver</h2>
                <p>Find all nth roots of complex numbers - exploring equations of the form <span id="eq-header"></span></p>
                
                <div class="disclaimer">
                    ⚡ AI-powered solver - The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic
                </div>
            </div>

            <div class="card">
                <h3>Solve <span id="equation-display"></span></h3>
                <p>This equation always has exactly n solutions, forming a beautiful geometric pattern</p>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="font-weight: 600;">n = </label>
                            <input type="number" id="n-value" value="4" min="2" max="12" 
                                   style="width: 60px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;">
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 600;">c = </label>
                            <input type="text" id="c-complex" placeholder="e.g., 1, -1, i, 2+2i" value="1" 
                                   style="width: 200px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div class="preset-pills" style="margin-top: 16px;">
                        <button class="preset-pill" onclick="setRootEquation(3, '1')">Cube roots of unity</button>
                        <button class="preset-pill" onclick="setRootEquation(4, '1')">4th roots of unity</button>
                        <button class="preset-pill" onclick="setRootEquation(6, '1')">6th roots of unity</button>
                        <button class="preset-pill" onclick="setRootEquation(8, '1')">8th roots of unity</button>
                        <button class="preset-pill" onclick="setRootEquation(4, '16')">4th roots of 16</button>
                        <button class="preset-pill" onclick="setRootEquation(3, '-8')">Cube roots of -8</button>
                        <button class="preset-pill" onclick="setRootEquation(2, 'i')">Square roots of i</button>
                        <button class="preset-pill" onclick="setRootEquation(4, '-16')">4th roots of -16</button>
                    </div>
                    
                    <button class="demo-button" onclick="solveRootEquation()" style="margin-top: 20px; width: 100%;">
                        Find All Roots <span class="ai-status" id="root-status" style="display:none;"><span class="loading-spinner"></span></span>
                    </button>
                </div>
                
                <div id="root-results" style="display:none; margin-top: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="roots-display">
                            <h4>All n Solutions:</h4>
                            <div id="root-list"></div>
                        </div>
                        
                        <div style="text-align: center;">
                            <canvas id="root-plane" width="300" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-top: 20px;">
                        <h4>Geometric Pattern</h4>
                        <p id="root-pattern"></p>
                        <p style="margin-top: 12px;"><strong>Key insight:</strong> All roots have the same distance from origin (the nth root of |c|), 
                        and are evenly spaced by angle 2π/n. Multiplying any root by itself n times gives back c.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'introduction';
        let additionNumbers = [];
        let multiplicationNumbers = [];
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Render initial math formulas
            katex.render("i^2 = -1", document.getElementById('i-definition'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("z = a + bi", document.getElementById('complex-form'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("\\sqrt{\\text{negative}} = \\sqrt{|\\text{negative}|} \\cdot i", 
                document.getElementById('discriminant-formula'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Render headers
            katex.render("x^2 + c", document.getElementById('factor-header'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("x^2 + bx + c = 0", document.getElementById('quadratic-header'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Info box formulas
            katex.render("b^2 - 4ac", document.getElementById('disc-formula'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("\\sqrt{\\text{negative}} = \\sqrt{|\\text{negative}|} \\cdot i", 
                document.getElementById('neg-sqrt'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Geometric tab formulas
            katex.render("r_1r_2\\angle(\\theta_1+\\theta_2)", document.getElementById('polar-mult'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("re^{i\\theta}", document.getElementById('exp-form'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("r_1e^{i\\theta_1} \\cdot r_2e^{i\\theta_2} = r_1r_2e^{i(\\theta_1+\\theta_2)}", 
                document.getElementById('exp-mult'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("re^{i\\theta}", document.getElementById('exp-form2'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("e^{i\\theta}", document.getElementById('exp-theta'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Equation solver headers
            katex.render("z^n = c", document.getElementById('eq-header'), {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render("z^n = c", document.getElementById('equation-display'), {
                displayMode: false,
                throwOnError: false
            });
            
            // Initialize sliders
            updateFactoring();
            updateQuadratic();
            
            // Add slider listeners
            document.getElementById('c-slider').addEventListener('input', updateFactoring);
            document.getElementById('b-slider').addEventListener('input', updateQuadratic);
            document.getElementById('c2-slider').addEventListener('input', updateQuadratic);
            
            // Initialize canvases
            if (currentTab === 'geometric') {
                initGeometricPlanes();
            }
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            if (tabName === 'geometric') {
                setTimeout(() => initGeometricPlanes(), 100);
            }
        }

        // Add tab button listeners
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // AI API call function
        async function callAI(prompt, maxRetries = 2) {
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: prompt }] }] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Empty response from AI');
                    }
                    
                    return text;
                    
                } catch (error) {
                    if (attempt === maxRetries) {
                        throw error;
                    }
                }
            }
        }

        // Introduction tab functions - Fixed to keep square roots as symbols
        function updateFactoring() {
            const c = parseFloat(document.getElementById('c-slider').value);
            document.getElementById('c-value').textContent = c;
            
            const factorDisplay = document.getElementById('factor-display');
            const rootsDisplay = document.getElementById('factor-roots');
            
            let factorLatex, rootsLatex;
            
            if (c > 0) {
                // Check if c is a perfect square
                const sqrtC = Math.sqrt(c);
                let rootStr;
                if (Number.isInteger(sqrtC)) {
                    rootStr = sqrtC.toString();
                } else if (Number.isInteger(c)) {
                    rootStr = `\\sqrt{${c}}`;
                } else {
                    rootStr = c.toFixed(1);
                }
                
                factorLatex = `x^2 + ${c} = \\left(x + ${rootStr}i\\right)\\left(x - ${rootStr}i\\right)`;
                rootsLatex = `\\text{Roots: } x = \\pm ${rootStr}i`;
            } else if (c < 0) {
                const absC = Math.abs(c);
                const sqrtAbsC = Math.sqrt(absC);
                let rootStr;
                if (Number.isInteger(sqrtAbsC)) {
                    rootStr = sqrtAbsC.toString();
                } else if (Number.isInteger(absC)) {
                    rootStr = `\\sqrt{${absC}}`;
                } else {
                    rootStr = absC.toFixed(1);
                }
                
                factorLatex = `x^2 ${c} = \\left(x + ${rootStr}\\right)\\left(x - ${rootStr}\\right)`;
                rootsLatex = `\\text{Roots: } x = \\pm ${rootStr}`;
            } else {
                factorLatex = `x^2 = x \\cdot x`;
                rootsLatex = `\\text{Root: } x = 0 \\text{ (double root)}`;
            }
            
            katex.render(factorLatex, factorDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            katex.render(rootsLatex, rootsDisplay, {
                displayMode: false,
                throwOnError: false
            });
        }

        function updateQuadratic() {
            const b = parseFloat(document.getElementById('b-slider').value);
            const c = parseFloat(document.getElementById('c2-slider').value);
            document.getElementById('b-value').textContent = b;
            document.getElementById('c2-value').textContent = c;
            
            const equationDisplay = document.getElementById('quadratic-equation');
            const discriminantDisplay = document.getElementById('discriminant-display');
            const rootsDisplay = document.getElementById('quadratic-roots');
            
            // Display equation
            const eqLatex = `x^2 ${b >= 0 ? '+' : ''} ${b}x ${c >= 0 ? '+' : ''} ${c} = 0`;
            katex.render(eqLatex, equationDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            // Calculate discriminant
            const disc = b * b - 4 * c;
            let discLatex = `\\text{Discriminant: } ${b}^2 - 4(${c}) = ${disc}`;
            
            if (disc < 0) {
                discLatex += ` < 0`;
            } else if (disc > 0) {
                discLatex += ` > 0`;
            } else {
                discLatex += ` = 0`;
            }
            
            katex.render(discLatex, discriminantDisplay, {
                displayMode: false,
                throwOnError: false
            });
            
            // Calculate roots with proper square root notation
            let rootsLatex;
            if (disc < 0) {
                const absDisc = Math.abs(disc);
                const sqrtAbsDisc = Math.sqrt(absDisc);
                let imagStr;
                
                if (Number.isInteger(sqrtAbsDisc) && sqrtAbsDisc % 2 === 0) {
                    imagStr = (sqrtAbsDisc / 2).toString();
                    rootsLatex = `x = \\frac{${-b} \\pm ${imagStr}i}{2}`;
                } else if (Number.isInteger(absDisc)) {
                    rootsLatex = `x = \\frac{${-b} \\pm \\sqrt{${absDisc}}i}{2}`;
                } else {
                    const realPart = (-b / 2).toFixed(2);
                    const imagPart = (sqrtAbsDisc / 2).toFixed(2);
                    rootsLatex = `x = ${realPart} \\pm ${imagPart}i`;
                }
            } else if (disc > 0) {
                const sqrtDisc = Math.sqrt(disc);
                if (Number.isInteger(sqrtDisc)) {
                    const root1 = (-b + sqrtDisc) / 2;
                    const root2 = (-b - sqrtDisc) / 2;
                    rootsLatex = `x = ${root1}, ${root2}`;
                } else if (Number.isInteger(disc)) {
                    rootsLatex = `x = \\frac{${-b} \\pm \\sqrt{${disc}}}{2}`;
                } else {
                    const root1 = ((-b + sqrtDisc) / 2).toFixed(2);
                    const root2 = ((-b - sqrtDisc) / 2).toFixed(2);
                    rootsLatex = `x = ${root1}, ${root2}`;
                }
            } else {
                const root = -b / 2;
                rootsLatex = `x = ${root}`;
            }
            
            katex.render(rootsLatex, rootsDisplay, {
                displayMode: false,
                throwOnError: false
            });
        }

        // Algebraic Explorer functions
        function setExpression(expr) {
            document.getElementById('complex-expression').value = expr;
        }

        async function checkAnswer() {
            const expression = document.getElementById('complex-expression').value;
            const userAnswer = document.getElementById('user-answer').value;
            const statusEl = document.getElementById('ai-status');
            const resultEl = document.getElementById('algebraic-result');
            const feedbackEl = document.getElementById('feedback-content');
            const challengeBtn = document.getElementById('challenge-btn');
            
            if (!expression || !userAnswer) {
                alert('Please enter both an expression and your answer');
                return;
            }
            
            statusEl.style.display = 'inline-flex';
            challengeBtn.style.display = 'none';
            
            const prompt = `Check if the user's simplification is correct.
            
            Expression: ${expression}
            User's answer: ${userAnswer}
            
            First, simplify the expression to the form a + bi.
            Then check if the user's answer matches.
            
            Format your response as JSON:
            {
                "correct_answer": "the correct a + bi form",
                "user_answer_matches": true/false,
                "feedback": "constructive feedback message",
                "steps": ["step 1", "step 2", ...]
            }
            
            Be encouraging and constructive. If answers don't match, explain kindly without being judgmental.`;
            
            try {
                const response = await callAI(prompt);
                const data = JSON.parse(response);
                
                // Create feedback
                const feedbackBox = document.createElement('div');
                feedbackBox.className = data.user_answer_matches ? 'feedback-box match' : 'feedback-box no-match';
                
                if (data.user_answer_matches) {
                    feedbackBox.innerHTML = `
                        <strong>Great work!</strong> Your answer matches the correct simplification.
                        <div style="margin-top: 8px;">${data.feedback}</div>
                    `;
                    challengeBtn.style.display = 'none';
                } else {
                    feedbackBox.innerHTML = `
                        <strong>The answers don't quite match.</strong> 
                        <div style="margin-top: 8px;">${data.feedback}</div>
                        <div style="margin-top: 8px;">The expression simplifies to: <strong>${data.correct_answer}</strong></div>
                    `;
                    challengeBtn.style.display = 'inline-block';
                }
                
                feedbackEl.innerHTML = '';
                feedbackEl.appendChild(feedbackBox);
                
                // Show steps if needed
                if (!data.user_answer_matches && data.steps && data.steps.length > 0) {
                    const stepsContainer = document.getElementById('steps-container');
                    const stepsEl = document.getElementById('solution-steps');
                    stepsEl.innerHTML = data.steps.map((step, i) => 
                        `<div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                            ${i + 1}. ${step}
                        </div>`
                    ).join('');
                    stepsContainer.style.display = 'block';
                } else {
                    document.getElementById('steps-container').style.display = 'none';
                }
                
                resultEl.style.display = 'block';
                
            } catch (error) {
                console.error('AI check failed:', error);
                feedbackEl.innerHTML = '<div class="feedback-box no-match">Unable to check with AI at this moment. Please try again.</div>';
                resultEl.style.display = 'block';
            } finally {
                statusEl.style.display = 'none';
            }
        }

        async function challengeAI() {
            const expression = document.getElementById('complex-expression').value;
            const userAnswer = document.getElementById('user-answer').value;
            const feedbackEl = document.getElementById('feedback-content');
            const challengeBtn = document.getElementById('challenge-btn');
            
            // Change button to show it's working
            challengeBtn.textContent = 'Reconsidering...';
            challengeBtn.disabled = true;
            
            const prompt = `The user believes their answer is correct and is challenging the AI's evaluation.
            
            Expression: ${expression}
            User's answer: ${userAnswer}
            
            Please reconsider the problem carefully. Check if there might be alternative correct forms.
            Remember that these are all equivalent:
            - 5 + i and 5 + 1i and 5 + i*1
            - 3 - 5i and -5i + 3
            - 0 + 2i and 2i
            - 7 + 0i and 7
            
            Be open to the possibility that the user might be right.
            
            Format response as JSON:
            {
                "reconsideration": "explanation of the reconsideration",
                "conclusion": "final determination - be specific about whether the answers match or not"
            }`;
            
            try {
                const response = await callAI(prompt);
                const data = JSON.parse(response);
                
                const feedbackBox = document.createElement('div');
                feedbackBox.className = 'feedback-box match';
                feedbackBox.style.marginTop = '12px';
                feedbackBox.innerHTML = `
                    <strong>AI Reconsideration:</strong>
                    <div style="margin-top: 8px;">${data.reconsideration}</div>
                    <div style="margin-top: 8px;"><strong>Conclusion:</strong> ${data.conclusion}</div>
                `;
                
                feedbackEl.appendChild(feedbackBox);
                
                // Hide the challenge button after use
                challengeBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Challenge failed:', error);
                const errorBox = document.createElement('div');
                errorBox.className = 'feedback-box no-match';
                errorBox.style.marginTop = '12px';
                errorBox.innerHTML = 'Unable to process challenge. Please try again.';
                feedbackEl.appendChild(errorBox);
            } finally {
                challengeBtn.textContent = 'Challenge AI\'s Answer';
                challengeBtn.disabled = false;
            }
        }

        // Geometric View functions
        function initGeometricPlanes() {
            drawAdditionPlane();
            drawMultiplicationPlane();
        }

        function drawAdditionPlane() {
            const canvas = document.getElementById('addition-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -4; i <= 4; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw numbers
            additionNumbers.forEach((num, i) => {
                const x = centerX + num.real * scale;
                const y = centerY - num.imag * scale;
                
                // Draw vector
                ctx.strokeStyle = i === 0 ? '#0f766e' : '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Draw point
                ctx.fillStyle = i === 0 ? '#0f766e' : '#10b981';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#212121';
                ctx.font = '12px sans-serif';
                const label = `z${i+1}`;
                ctx.fillText(label, x + 8, y - 8);
            });
        }

        function drawMultiplicationPlane() {
            const canvas = document.getElementById('multiplication-plane');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 40;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -4; i <= 4; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw unit circle
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.arc(centerX, centerY, scale, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw numbers with angle arcs
            multiplicationNumbers.forEach((num, i) => {
                const x = centerX + num.real * scale;
                const y = centerY - num.imag * scale;
                const r = Math.sqrt(num.real * num.real + num.imag * num.imag);
                const theta = Math.atan2(num.imag, num.real);
                
                // Draw angle arc
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(centerX, centerY, 20, 0, -theta, theta > 0);
                ctx.stroke();
                
                // Draw vector
                ctx.strokeStyle = i === 0 ? '#0f766e' : '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Draw point
                ctx.fillStyle = i === 0 ? '#0f766e' : '#10b981';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#212121';
                ctx.font = '11px sans-serif';
                const angle = (theta * 180 / Math.PI).toFixed(0);
                const label = `z${i+1}: r=${r.toFixed(1)}, θ=${angle}°`;
                ctx.fillText(label, x + 8, y - 8);
            });
        }

        function addNumberToAdditionPlane() {
            if (additionNumbers.length >= 2) {
                additionNumbers = [];
            }
            const real = Math.random() * 6 - 3;
            const imag = Math.random() * 6 - 3;
            additionNumbers.push({ real, imag });
            drawAdditionPlane();
            
            const info = document.getElementById('addition-info');
            if (additionNumbers.length === 2) {
                const z1 = additionNumbers[0];
                const z2 = additionNumbers[1];
                info.innerHTML = `z₁ = ${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i, 
                                 z₂ = ${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i`;
            }
        }

        function showAddition() {
            if (additionNumbers.length !== 2) {
                alert('Please add exactly 2 numbers first');
                return;
            }
            
            const z1 = additionNumbers[0];
            const z2 = additionNumbers[1];
            const sum = {
                real: z1.real + z2.real,
                imag: z1.imag + z2.imag
            };
            
            // Check if sum is within bounds
            if (Math.abs(sum.real) > 4 || Math.abs(sum.imag) > 4) {
                document.getElementById('addition-info').innerHTML = 
                    `Sum: (${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i) + 
                    (${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i) = 
                    ${sum.real.toFixed(2)} + ${sum.imag.toFixed(2)}i <strong>(outside view)</strong>`;
                return;
            }
            
            // Draw the sum
            const canvas = document.getElementById('addition-plane');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 40;
            
            const x = centerX + sum.real * scale;
            const y = centerY - sum.imag * scale;
            
            // Draw parallelogram
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            const x1 = centerX + z1.real * scale;
            const y1 = centerY - z1.imag * scale;
            const x2 = centerX + z2.real * scale;
            const y2 = centerY - z2.imag * scale;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x, y);
            ctx.moveTo(x2, y2);
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw sum vector
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw sum point
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Update info
            const info = document.getElementById('addition-info');
            info.innerHTML = `Sum: (${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i) + 
                            (${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i) = 
                            ${sum.real.toFixed(2)} + ${sum.imag.toFixed(2)}i`;
        }

        function showSubtraction() {
            if (additionNumbers.length !== 2) {
                alert('Please add exactly 2 numbers first');
                return;
            }
            
            const z1 = additionNumbers[0];
            const z2 = additionNumbers[1];
            const diff = {
                real: z1.real - z2.real,
                imag: z1.imag - z2.imag
            };
            
            // Check if difference is within bounds
            if (Math.abs(diff.real) > 4 || Math.abs(diff.imag) > 4) {
                document.getElementById('addition-info').innerHTML = 
                    `Difference: (${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i) - 
                    (${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i) = 
                    ${diff.real.toFixed(2)} + ${diff.imag.toFixed(2)}i <strong>(outside view)</strong>`;
                return;
            }
            
            // Draw the difference
            const canvas = document.getElementById('addition-plane');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 40;
            
            drawAdditionPlane(); // Redraw to clear previous operations
            
            const x = centerX + diff.real * scale;
            const y = centerY - diff.imag * scale;
            
            // Draw difference vector
            ctx.strokeStyle = '#c62828';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw difference point
            ctx.fillStyle = '#c62828';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Update info
            const info = document.getElementById('addition-info');
            info.innerHTML = `Difference: (${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i) - 
                            (${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i) = 
                            ${diff.real.toFixed(2)} + ${diff.imag.toFixed(2)}i`;
        }

        function clearAdditionPlane() {
            additionNumbers = [];
            drawAdditionPlane();
            document.getElementById('addition-info').innerHTML = '';
        }

        function addNumberToMultPlane() {
            if (multiplicationNumbers.length >= 2) {
                multiplicationNumbers = [];
            }
            const angle = Math.random() * 2 * Math.PI;
            const r = 0.5 + Math.random() * 2;
            const real = r * Math.cos(angle);
            const imag = r * Math.sin(angle);
            multiplicationNumbers.push({ real, imag });
            drawMultiplicationPlane();
            
            const info = document.getElementById('mult-info');
            if (multiplicationNumbers.length === 2) {
                const z1 = multiplicationNumbers[0];
                const z2 = multiplicationNumbers[1];
                const r1 = Math.sqrt(z1.real * z1.real + z1.imag * z1.imag);
                const r2 = Math.sqrt(z2.real * z2.real + z2.imag * z2.imag);
                const theta1 = Math.atan2(z1.imag, z1.real) * 180 / Math.PI;
                const theta2 = Math.atan2(z2.imag, z2.real) * 180 / Math.PI;
                info.innerHTML = `z₁: r=${r1.toFixed(2)}, θ=${theta1.toFixed(0)}° | 
                                 z₂: r=${r2.toFixed(2)}, θ=${theta2.toFixed(0)}°`;
            }
        }

        function showMultiplication() {
            if (multiplicationNumbers.length !== 2) {
                alert('Please add exactly 2 numbers first');
                return;
            }
            
            const z1 = multiplicationNumbers[0];
            const z2 = multiplicationNumbers[1];
            
            // Complex multiplication
            const product = {
                real: z1.real * z2.real - z1.imag * z2.imag,
                imag: z1.real * z2.imag + z1.imag * z2.real
            };
            
            // Polar form
            const r1 = Math.sqrt(z1.real * z1.real + z1.imag * z1.imag);
            const r2 = Math.sqrt(z2.real * z2.real + z2.imag * z2.imag);
            const theta1 = Math.atan2(z1.imag, z1.real);
            const theta2 = Math.atan2(z2.imag, z2.real);
            const rProduct = r1 * r2;
            const thetaProduct = theta1 + theta2;
            
            // Check if product is within bounds
            if (Math.abs(product.real) > 4 || Math.abs(product.imag) > 4) {
                const info = document.getElementById('mult-info');
                info.innerHTML = `Product: r₁r₂ = ${r1.toFixed(2)} × ${r2.toFixed(2)} = ${rProduct.toFixed(2)}<br>
                                θ₁+θ₂ = ${(theta1*180/Math.PI).toFixed(0)}° + ${(theta2*180/Math.PI).toFixed(0)}° = ${(thetaProduct*180/Math.PI).toFixed(0)}°<br>
                                Result: ${product.real.toFixed(2)} + ${product.imag.toFixed(2)}i <strong>(outside view)</strong>`;
                return;
            }
            
            // Draw the product
            const canvas = document.getElementById('multiplication-plane');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 40;
            
            drawMultiplicationPlane(); // Redraw to clear
            
            const x = centerX + product.real * scale;
            const y = centerY - product.imag * scale;
            
            // Draw product vector
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw angle arc for product
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, -thetaProduct, thetaProduct > 0);
            ctx.stroke();
            
            // Draw product point
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Update info
            const info = document.getElementById('mult-info');
            info.innerHTML = `Product: r₁r₂ = ${r1.toFixed(2)} × ${r2.toFixed(2)} = ${rProduct.toFixed(2)}<br>
                            θ₁+θ₂ = ${(theta1*180/Math.PI).toFixed(0)}° + ${(theta2*180/Math.PI).toFixed(0)}° = ${(thetaProduct*180/Math.PI).toFixed(0)}°<br>
                            Result: ${product.real.toFixed(2)} + ${product.imag.toFixed(2)}i`;
        }

        function showDivision() {
            if (multiplicationNumbers.length !== 2) {
                alert('Please add exactly 2 numbers first');
                return;
            }
            
            const z1 = multiplicationNumbers[0];
            const z2 = multiplicationNumbers[1];
            
            // Check for division by zero
            if (z2.real === 0 && z2.imag === 0) {
                alert('Cannot divide by zero');
                return;
            }
            
            // Complex division: (a+bi)/(c+di) = ((ac+bd) + (bc-ad)i)/(c²+d²)
            const denominator = z2.real * z2.real + z2.imag * z2.imag;
            const quotient = {
                real: (z1.real * z2.real + z1.imag * z2.imag) / denominator,
                imag: (z1.imag * z2.real - z1.real * z2.imag) / denominator
            };
            
            // Polar form
            const r1 = Math.sqrt(z1.real * z1.real + z1.imag * z1.imag);
            const r2 = Math.sqrt(z2.real * z2.real + z2.imag * z2.imag);
            const theta1 = Math.atan2(z1.imag, z1.real);
            const theta2 = Math.atan2(z2.imag, z2.real);
            const rQuotient = r1 / r2;
            const thetaQuotient = theta1 - theta2;
            
            // Check if quotient is within bounds
            if (Math.abs(quotient.real) > 4 || Math.abs(quotient.imag) > 4) {
                const info = document.getElementById('mult-info');
                info.innerHTML = `Quotient: r₁/r₂ = ${r1.toFixed(2)} ÷ ${r2.toFixed(2)} = ${rQuotient.toFixed(2)}<br>
                                θ₁-θ₂ = ${(theta1*180/Math.PI).toFixed(0)}° - ${(theta2*180/Math.PI).toFixed(0)}° = ${(thetaQuotient*180/Math.PI).toFixed(0)}°<br>
                                Result: ${quotient.real.toFixed(2)} + ${quotient.imag.toFixed(2)}i <strong>(outside view)</strong>`;
                return;
            }
            
            // Draw the quotient
            const canvas = document.getElementById('multiplication-plane');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 40;
            
            drawMultiplicationPlane(); // Redraw to clear
            
            const x = centerX + quotient.real * scale;
            const y = centerY - quotient.imag * scale;
            
            // Draw quotient vector
            ctx.strokeStyle = '#c62828';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // Draw angle arc for quotient
            ctx.strokeStyle = '#c62828';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, -thetaQuotient, thetaQuotient > 0);
            ctx.stroke();
            
            // Draw quotient point
            ctx.fillStyle = '#c62828';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Update info
            const info = document.getElementById('mult-info');
            info.innerHTML = `Quotient: r₁/r₂ = ${r1.toFixed(2)} ÷ ${r2.toFixed(2)} = ${rQuotient.toFixed(2)}<br>
                            θ₁-θ₂ = ${(theta1*180/Math.PI).toFixed(0)}° - ${(theta2*180/Math.PI).toFixed(0)}° = ${(thetaQuotient*180/Math.PI).toFixed(0)}°<br>
                            Result: ${quotient.real.toFixed(2)} + ${quotient.imag.toFixed(2)}i`;
        }

        function clearMultPlane() {
            multiplicationNumbers = [];
            drawMultiplicationPlane();
            document.getElementById('mult-info').innerHTML = '';
        }

        // Equation Solver functions
        function setRootEquation(n, c) {
            document.getElementById('n-value').value = n;
            document.getElementById('c-complex').value = c;
        }

        async function solveRootEquation() {
            const n = parseInt(document.getElementById('n-value').value);
            const c = document.getElementById('c-complex').value;
            const statusEl = document.getElementById('root-status');
            const resultsEl = document.getElementById('root-results');
            const rootList = document.getElementById('root-list');
            const patternEl = document.getElementById('root-pattern');
            
            statusEl.style.display = 'inline-flex';
            
            const prompt = `Solve z^${n} = ${c}
            
            Find all ${n} complex roots. Use De Moivre's formula.
            Remember: All roots have the same modulus (nth root of |c|), and are evenly spaced by angle 2π/n.
            
            Format as JSON:
            {
                "roots": [
                    {"real": number, "imaginary": number, "exact": "exact form if possible"},
                    ...
                ],
                "pattern": "Explain the geometric pattern: all ${n} roots have modulus = ${n}th root of |c|, and consecutive roots are separated by angle 2π/${n}"
            }`;
            
            try {
                const response = await callAI(prompt);
                const data = JSON.parse(response);
                
                // Display roots with proper subscripts
                rootList.innerHTML = '';
                data.roots.forEach((root, i) => {
                    const rootItem = document.createElement('div');
                    rootItem.className = 'root-item';
                    
                    const labelSpan = document.createElement('span');
                    katex.render(`z_{${i+1}}:`, labelSpan, {
                        displayMode: false,
                        throwOnError: false
                    });
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'root-value';
                    valueSpan.textContent = root.exact || `${root.real.toFixed(3)} + ${root.imaginary.toFixed(3)}i`;
                    
                    rootItem.appendChild(labelSpan);
                    rootItem.appendChild(valueSpan);
                    rootList.appendChild(rootItem);
                });
                
                // Draw on plane
                const canvas = document.getElementById('root-plane');
                drawRootsOnPlane(canvas, data.roots);
                
                // Show pattern
                patternEl.innerHTML = data.pattern;
                
                resultsEl.style.display = 'block';
                
            } catch (error) {
                console.error('Solver failed:', error);
                rootList.innerHTML = '<div class="root-item">Unable to solve. Please try again.</div>';
                resultsEl.style.display = 'block';
            } finally {
                statusEl.style.display = 'none';
            }
        }

        function drawRootsOnPlane(canvas, roots) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 60;
            
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = -2; i <= 2; i++) {
                const x = centerX + i * scale;
                const y = centerY - i * scale;
                
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw unit circle
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.arc(centerX, centerY, scale, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw axes
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Draw roots
            roots.forEach((root, i) => {
                const x = centerX + root.real * scale;
                const y = centerY - root.imaginary * scale;
                
                // Draw line from origin
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw point
                ctx.fillStyle = '#0f766e';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label with subscript notation
                ctx.fillStyle = '#212121';
                ctx.font = '10px sans-serif';
                ctx.fillText(`z${i+1}`, x + 6, y - 6);
            });
            
            // Connect roots if they form a regular polygon (roots of unity)
            if (roots.length > 2) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                roots.forEach((root, i) => {
                    const x = centerX + root.real * scale;
                    const y = centerY - root.imaginary * scale;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }

        // Canvas click handlers
        document.getElementById('addition-plane')?.addEventListener('click', function(e) {
            if (additionNumbers.length >= 2) {
                additionNumbers = [];
            }
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = this.width / 2;
            const centerY = this.height / 2;
            const scale = 40;
            
            const real = (x - centerX) / scale;
            const imag = -(y - centerY) / scale;
            
            additionNumbers.push({ real, imag });
            drawAdditionPlane();
            
            const info = document.getElementById('addition-info');
            if (additionNumbers.length === 1) {
                info.innerHTML = `z₁ = ${real.toFixed(2)} + ${imag.toFixed(2)}i`;
            } else if (additionNumbers.length === 2) {
                const z1 = additionNumbers[0];
                const z2 = additionNumbers[1];
                info.innerHTML = `z₁ = ${z1.real.toFixed(2)} + ${z1.imag.toFixed(2)}i, 
                                 z₂ = ${z2.real.toFixed(2)} + ${z2.imag.toFixed(2)}i`;
            }
        });

        document.getElementById('multiplication-plane')?.addEventListener('click', function(e) {
            if (multiplicationNumbers.length >= 2) {
                multiplicationNumbers = [];
            }
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = this.width / 2;
            const centerY = this.height / 2;
            const scale = 40;
            
            const real = (x - centerX) / scale;
            const imag = -(y - centerY) / scale;
            
            multiplicationNumbers.push({ real, imag });
            drawMultiplicationPlane();
            
            const info = document.getElementById('mult-info');
            if (multiplicationNumbers.length === 2) {
                const z1 = multiplicationNumbers[0];
                const z2 = multiplicationNumbers[1];
                const r1 = Math.sqrt(z1.real * z1.real + z1.imag * z1.imag);
                const r2 = Math.sqrt(z2.real * z2.real + z2.imag * z2.imag);
                const theta1 = Math.atan2(z1.imag, z1.real) * 180 / Math.PI;
                const theta2 = Math.atan2(z2.imag, z2.real) * 180 / Math.PI;
                info.innerHTML = `z₁: r=${r1.toFixed(2)}, θ=${theta1.toFixed(0)}° | 
                                 z₂: r=${r2.toFixed(2)}, θ=${theta2.toFixed(0)}°`;
            }
        });
    </script>
</body>
</html>
